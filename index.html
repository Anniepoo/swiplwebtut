<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<title>Tutorial&#8201;&#8212;&#8201;Creating Web Applications in SWI-Prolog</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }


div.imageblock {
	float: right;
	margin-left: 8px;
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Tutorial&#8201;&#8212;&#8201;Creating Web Applications in SWI-Prolog</h1>
<span id="author">Anne Ogborn</span><br />
<span id="email"><code>&lt;<a href="mailto:annie66us@yahoo.com">annie66us@yahoo.com</a>&gt;</code></span><br />
<span id="revnumber">version 1.3.1,</span>
<span id="revdate">May 19, 2020</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><a href="/swipltuts/index.html">Up to All Tutorials</a></p></div>
<div class="paragraph"><p>This tutorial updated May 19, 2020</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_expected_results">1.1. Expected Results</h3>
<div class="paragraph"><p>If you enter this course knowing SWI-Prolog well and have some experience with web development, you should be able to competently write production web applications afterwards. The learning curve is pleasantly short.</p></div>
</div>
<div class="sect2">
<h3 id="_time">1.2. Time</h3>
<div class="paragraph"><p>3-6 hours if you do all the exercises. You can start writing <em>real</em> code after finishing section 3 at minimum.</p></div>
</div>
<div class="sect2">
<h3 id="_who_this_course_is_for">1.3. Who This Course Is For</h3>
<div class="paragraph"><p>This course is for anyone who knows SWI-Prolog reasonably well and wants to learn the web application framework bundled with SWI-Prolog. You will also need some fluency with web development basics like HTML, CSS, and HTTP.</p></div>
<div class="paragraph"><p>Many programmers assume Prolog needs to be hosted with a <em>normal</em> language. I&#8217;m not sure why. Certainly xpce wouldn&#8217;t be suitable for many desktop gui systems. But those are becoming rare. Even the desktop systems I&#8217;ve written recently have been written as web servers that display the UI in the browser. This course is part of my response to this mentality.</p></div>
</div>
<div class="sect2">
<h3 id="_why_prolog">1.4. Why Prolog?</h3>
<div class="paragraph"><p>Prolog is of course more associated with expert systems and torturing undergraduates than with production web applications. But I&#8217;ve found it an excellent system for building web applications as well.</p></div>
<div class="paragraph"><p>Prolog programs are simply <strong>smaller</strong> . Prolog programs are often <strong>one tenth</strong> the size of equivalent Java programs. And smallness is a virtuous cycle. Smallness encourages well written code, and well written code is easier to maintain and refactor and remains small.</p></div>
<div class="paragraph"><p>What makes Prolog systems small? Complex question, but we can identify various factors. With backtracking instead of control structures, Prolog eliminates the 90% of loops that are actually iterators. Backtracking often eliminates error handling. Partial binding and incomplete structures eliminate much data reformatting. And in general, there&#8217;s just a lot more case based reasoning, which means a lot less ceremony associated with handling of edge conditions. And of course you can put a small reasoner in to figure out complex business logic like <em>who&#8217;s allowed to edit this?</em></p></div>
<div class="paragraph"><p>The SWI-Prolog web app framework is very friendly. You can edit running code and query make. (C-c C-m in the IDE editor) and keep going without disturbing state, and you can use the graphic debugger.</p></div>
</div>
<div class="sect2">
<h3 id="_does_anybody_actually_use_this">1.5. Does Anybody Actually Use This?</h3>
<div class="paragraph"><p>All these systems are in Prolog, using the web framework described in this tutorial.</p></div>
<div class="paragraph"><p><span class="image">
<img src="systemsusingprolog.png" alt="The best way to be cool and ahead of the curve is by asking if large companies are using the technology before you try it" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_getting_the_most_from_this_course">1.6. Getting The Most From This Course</h3>
<div class="paragraph"><p>This course is this web page and a series of example programs.</p></div>
<div class="paragraph"><p>The examples are designed to take reasonable sized bites at a subject, progressively building knowledge. I introduce some subjects in one place, then revisit them later to deepen understanding.</p></div>
<div class="paragraph"><p>The example programs are <strong>not</strong> reproduced here. I want you to actually <strong>look at</strong> and <strong>fiddle with</strong> the code. So hopefully you&#8217;ll be encouraged to fiddle if you have to read the code locally. You can get the examples at <a href="https://github.com/Anniepoo/swiplwebtut">https://github.com/Anniepoo/swiplwebtut</a></p></div>
<div class="paragraph"><p>To get the most from this course, you&#8217;ll need to</p></div>
<div class="ulist"><ul>
<li>
<p>
Have a working <a href="http://www.swi-prolog.org">swi-Prolog</a> install
</p>
</li>
<li>
<p>
Get the example files from <a href="https://github.com/Anniepoo/swiplwebtut">github</a>
</p>
</li>
<li>
<p>
Understand Prolog and SWI-Prolog&#8217;s dialect before trying to build web apps
</p>
</li>
<li>
<p>
Read the text
</p>
</li>
<li>
<p>
Try each example program. Especially, look at the source of the resulting page. Experiment!
</p>
</li>
<li>
<p>
Do the exercises
</p>
</li>
</ul></div>
<div class="paragraph"><p>The example programs are labelled with a number scheme that once aligned with the chapter and section number, so webserver1_2.pl was the code for chapter one section 2. They&#8217;ve long since drifted out of alignment, and I&#8217;ve just put the number in the heading.</p></div>
<div class="paragraph"><p>Different people will have different backgrounds and learning styles. Whatever works for you works.</p></div>
<div class="paragraph"><p><a href="http://www.swi-prolog.org/howto/http/">This page</a> in the SWI-Prolog docs is useful as well</p></div>
<div class="sect3">
<h4 id="_getting_stuck">1.6.1. Getting Stuck</h4>
<div class="paragraph"><p>Many of the exercises in this tutorial were designed to push you to go explore the documentation. I feel students learn more from doing tasks like <em>real programmers</em>, and <em>how do I do X</em> is a daily experience for all of us. So don&#8217;t assume you can do all the exercises from this document! You can&#8217;t!</p></div>
<div class="paragraph"><p>If you have questions and reasonable effort doesn&#8217;t answer them, drop me email at <a href="mailto:annie@theelginworks.com">annie@theelginworks.com</a> . Please, if you&#8217;re taking a beginning Prolog course, ask your instructor basic Prolog questions. Questions about family trees will be ignored. But if you&#8217;re working on a web app, feel free.</p></div>
<div class="paragraph"><p>Asking on ##Prolog on freenode.net is also a good way to get answers.</p></div>
<div class="paragraph"><p>Finally, I well could be wrong. This material&#8217;s not that well documented in spots, and I&#8217;m making these tutorials partly to teach myself. While the web app <strong>feels</strong> nice to handle, in practice I&#8217;ve had a frustrating number of wtf moments. I&#8217;m hoping this tutorial will help change that.</p></div>
</div>
<div class="sect3">
<h4 id="_learning_by_doing">1.6.2. Learning By Doing</h4>
<div class="paragraph"><p>The only way to really become competent with an API is to use it. So, just as much as exercises or this page, I encourage you to make a project with the SWI tools. At the end of the course there&#8217;s a plea for people to help with a library of web patterns. If you don&#8217;t have a specific project, you might consider doing that.</p></div>
<div class="paragraph"><p>If you&#8217;re the "dive in and figure it out, make a toy project" sort, you may want to peek ahead to the parameters section at some point, as the course order slogs through all of html generation first, an orderly process but one that means you&#8217;re limited what you can build til you get there.</p></div>
<div class="paragraph"><p>With all that out of the way, on to the tutorial.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overall_flow">2. Overall Flow</h2>
<div class="sectionbody">
<div class="paragraph"><p>To orient you, I&#8217;m going to trace through the overall flow of a request first.</p></div>
<div class="paragraph"><p>A request arrives at a socket (usually port 80). <code>http_dispatch</code> assigns a thread from a thread pool, which parses the headers and stops reading. It decodes the path and finds a matching <strong>route</strong>. It takes all the information it has about the request and forms it into a <em>request object</em>, a list of options, containing such items as the headers, the requestor&#8217;s IP address, the search terms, and so on.</p></div>
<div class="paragraph"><p>It then passes the request object through any installed <code>http_request_expansion</code> filters, which may mutate it or throw an exception.</p></div>
<div class="paragraph"><p>The application programmer supplied handler predicate is then called, with <em>Request</em> as an additional argument.</p></div>
<div class="paragraph"><p>This predicate is expected to write the page, including the headers to <code>current_output</code>. This will be interpreted as a <strong>CGI Document</strong>.</p></div>
<div class="paragraph"><p>That this is a CGI document and not simply raw bytes for the socket is important because there are a few CGI directives, notably, one can set the status this way.</p></div>
<div class="paragraph"><p>However, something higher level usually happens.</p></div>
<div class="paragraph"><p>The application programmer will get any needed headers, and extract and validate the search parameters via <code>http_parameters</code>.
If this is a POST request, this is also when the body is normally  read in.</p></div>
<div class="paragraph"><p>For REST API&#8217;s, <code>http_read_json_dict/2</code> neatly converts the incoming JSON to a dict term, and <code>reply_json_dict/1</code> neatly gives back a dict as JSON.</p></div>
<div class="paragraph"><p>For HTML, the usual way to generate a page is via <code>reply_html_page</code>.</p></div>
<div class="paragraph"><p>The application programmer provides a <strong>DCG</strong> that defines material to be inserted in the head, and a <strong>DCG</strong> that
defines material to be inserted in the body - a sequence of atoms, like <code>[<em>&lt;p&gt;</em>, <em>hello out there</em>, <em>&lt;/p&gt;</em>]</code>. I call
this <strong>tokenized HTML</strong>. I&#8217;ll describe the sequence for the body, the head&#8217;s sequence is similar.</p></div>
<div class="paragraph"><p>Usually the application programmer won&#8217;t generate this material directly, but rather call the DCG <code>html//1</code>, passing
a Prolog term that defines HTML as a nested structure, a form I call <strong>tokenized HTML</strong>. This tokenized HTML is a much
more powerful language than "normal" HTML. You can of course insert normal HTML if convenient.</p></div>
<div class="paragraph"><p>Once this <strong>tokenized HTML</strong> is emitted, it passes through a number of stages on it&#8217;s way out via <code>print_html</code>.</p></div>
<div class="paragraph"><p>Material can be emitted at one place and placed another, the so called <em>Mailman</em> service. This is often used to ensure bits of script end up in the head, but has other uses.</p></div>
<div class="paragraph"><p>Material is <em>styled</em> by passing through the user supplied expansion <code>user:body//2</code> (+user:head//2 for the head).</p></div>
<div class="paragraph"><p>The tokenized HTML is then <em>formatted</em>, inserting newlines so it&#8217;s somewhat readable (confession, definitely it&#8217;s "somewhat").</p></div>
<div class="paragraph"><p>The final output from <code>print_html</code> is a CGI document interpreted by the system.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise
Draw yourself a diagram of the above</p></div>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_handlers">3. Setting Up Handlers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_hello_web">3.1. Hello Web</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Hello Web example</div>
<div class="paragraph"><p>See file helloweb.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>(Like always, I&#8217;m assuming you&#8217;re reading the code in the SWI-Prolog IDE, so I&#8217;m not showing the code here).</p></div>
<div class="paragraph"><p>Web apps in SWI-Prolog can be run in various ways. The one we&#8217;ll use to start is simply running as our own web server. I&#8217;m going to cover the larger issues later, so for now I&#8217;ll give you a bit of voodoo code to get a basic server up and running</p></div>
<div class="paragraph"><p>These lines include modules needed for our basic server</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(http/thread_httpd)).

:- use_module(library(http/http_dispatch)).</code></pre>
</div></div>
<div class="paragraph"><p>And this is our main server loop.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>server(Port) :-
        http_server(http_dispatch, [port(Port)]).</code></pre>
</div></div>
<div class="paragraph"><p>Query <code>server(8000).</code>  to start the server on port 8000 and browse <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise
Run helloweb.pl, start the server, and look at result in browser</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_handlers">3.2. Handlers</h3>
<div class="paragraph"><p>SWI-Prolog web apps are defined as a collection of <strong>handlers</strong> . The first topic we&#8217;ll cover is defining handlers. If you know Ruby on Rails these are like <em>routes</em>.</p></div>
<div class="paragraph"><p>We have a single handler that handles the root path /</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler(/, say_hi, []).</code></pre>
</div></div>
<div class="paragraph"><p>This declaration says <em>handle the root of the tree by querying the goal say_hi.</em></p></div>
<div class="paragraph"><p>The first argument, /, is an atom that means <em>the root of the URI</em>. So if we instead wanted our server to serve <a href="http://127.0.0.1:8000/twinkly/elf/weenblat.xls">http://127.0.0.1:8000/twinkly/elf/weenblat.xls</a> we&#8217;d say</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler('/twinkly/elf/weenblat.xls', say_hi, []).</code></pre>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise
serve Hello World from <a href="http://localhost:8000/hello.txt">http://localhost:8000/hello.txt</a></p></div>
<div class="paragraph"><p>Exercise (harder)
serve Hello World from any URI under <a href="http://localhost:8000/">http://localhost:8000/</a></p></div>
</div></div>
<div class="paragraph"><p>The second argument will be called with <code>call(Arg, Request)</code>, where Request is the request info. This enables the handy trick of making similar handlers into a single pred with specialization, like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler('/something/pleasant', my_handler_code(pleasant), []).
:- http_handler('/something/painful', my_handler_code(painful(normal)), []).
:- http_handler('/something/very/painful', my_handler_code(painful(very)), []).
:- http_handler('/something/incredibly/painful',
                my_handler_code(painful(incredibly)), []).

my_handler_code(WhatToSay, Request) :-
    in here WhatToSay will be bound to pleasant, painful(normal),
        painful(very), or painful(incredibly)
    and Request is a complex term that represents the httprequest (covered later)</code></pre>
</div></div>
<div class="paragraph"><p>The last argument is a set of options. The most interesting of these is <code>prefix</code>, which lets a single handler handle everything below the route as well. If you need to override an existing handler, you may need the priority option. <code>priority(0)</code> is default.</p></div>
<div class="paragraph"><p>Now we&#8217;re ready for the actual handler rule.</p></div>
<div class="paragraph"><p>When the rule is called the current input stream has been redirected to read the HTTPRequest, and current output has been redirected out the socket, so all we need do is print the response.</p></div>
<div class="paragraph"><p>We&#8217;ll first write the required Content-type: header and then the body.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(_Request) :-
        format('Content-type: text/plain~n~n'),
        format('Hello World!~n').</code></pre>
</div></div>
<div class="paragraph"><p>Don&#8217;t worry, this is NOT the usual way of writing content. But that&#8217;s chapter 2!</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Different hello messages</div>
<div class="paragraph"><p>Exercise:
Add handlers to helloweb.pl that print two different hello messages and share a single handler rule.</p></div>
<div class="paragraph"><p>Exercise (harder):
serve up a small png image just using format calls</p></div>
<div class="paragraph"><p>Exercise:
Add the Server: header to the response, using <code>version/1</code> to get the SWI-Prolog version of your SWI-Prolog install.
The header should look something like</p></div>
<div class="literalblock">
<div class="content">
<pre><code>Server: Apache/2.4.1 (Unix)</code></pre>
</div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_abstract_paths">3.3. Abstract Paths</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Abstract Path example</div>
<div class="paragraph"><p>See file abstract_path.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Anyone who&#8217;se made a large web app will be worried by the way we&#8217;ve been encoding our HTTP paths. <em>/fluffybunny</em> is fine for a small website, but imagine maintaining a large system with all these absolute paths hard coded.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">If you&#8217;re used to Apache based systems you probably associate an URI path with a file path. e.g. this tutorial will be found at <a href="http://www.pathwayslms.com/swipltuts/html/index.html">http://www.pathwayslms.com/swipltuts/html/index.html</a>  . But it&#8217;s served by sending the contents of a file, index.html, at /var/www/swipltuts/index.html on my server. The first is an URI path, the second a file path. They&#8217;re different!</td>
</tr></table>
</div>
<div class="paragraph"><p>The solution is what SWI-Prolog calls <em>abstract paths</em>.</p></div>
<div class="paragraph"><p>The abstract path library is at <a href="http://www.swi-prolog.org/pldoc/doc/swi/library/http/http_path.pl">http://www.swi-prolog.org/pldoc/doc/swi/library/http/http_path.pl</a> if you want the gory details.</p></div>
<div class="paragraph"><p>In example abstract_path.pl our handler declarations have changed. They now look like</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler(root(.), say_hi, []).

% And, just for clarity, define a second handler
% this one can by reached at http://127.0.0.1:8000/taco
:- http_handler(root(taco), say_taco, []).</code></pre>
</div></div>
<div class="paragraph"><p>The first is our old friend, the root handler, which serves <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></p></div>
<div class="paragraph"><p>Paths are offsets from an abstract base. In our case, the only abstract base is the built in one, root, which is defined as /.</p></div>
<div class="paragraph"><p>So / is root(.), /taco is root(taco), and <code>root(foo/bar)</code> is /foo/bar (note, not  <code>root(foo(bar))</code>).</p></div>
<div class="paragraph"><p>A couple things of note. First, <code>root(foo/bar)</code> is OK, as is root(<em>foo/bar</em>).</p></div>
<div class="paragraph"><p>Second, the non-atom form allows variables.</p></div>
<div class="paragraph"><p>Here&#8217;s an example that handles something like <code>http://example.com/store/34734642934621/cart</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler(root(store/Session/cart), handle_cart(Session), []).

handle_cart(Session, Request) :-
        % at this point we have the Session portion of the path</code></pre>
</div></div>
<div class="paragraph"><p>You&#8217;re probably thinking, other than syntactic change, so what?</p></div>
<div class="paragraph"><p>On to</p></div>
</div>
<div class="sect2">
<h3 id="_defining_new_abstract_paths">3.4. Defining new abstract paths</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">New Abstract Path example</div>
<div class="paragraph"><p>See file new_abstract_path.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The example new_abstract_path.pl code adds a hook predicate that defines a new abstract path. With it, we can now say files(<em>zap.gif</em>) to serve /f/zap.gif. If we move the files somewhere else we can just change one line.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/important.png" alt="Important" />
</td>
<td class="content">The path to the root of <strong>files</strong> (second arg) is an absolute path specification, not root(.)</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content">
<pre><code>:- multifile http:location/3.
:- dynamic   http:location/3.

http:location(files, '/f', []).</code></pre>
</div></div>
<div class="paragraph"><p>Also notice that <code>location</code> is arity 3. It takes a list of options, the only valid option being <code>priority(</code>:integer)+ which is used to disambiguate multiple handlers that handle the same URI. This is useful for defining a fallback handler for prefix of / to make a custom <em>not found</em> page instead of 404ing, and for overriding portions of the URI space.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/important.png" alt="Important" />
</td>
<td class="content">I was tryig to make these <em>abstract paths</em> be abstract files paths for a long time when learning this stuff. Beware, the two have nothing to do with each other. To make things worse, later on we&#8217;ll encounter them used together.</td>
</tr></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">sorry, not here exercise</div>
<div class="paragraph"><p>EXERCISE:
create a new abstract path /food/ and move taco to be under it</p></div>
<div class="paragraph"><p>EXERCISE:
Abstract URI paths really only become useful as a website grows, and things need moved around.
Extend the previous exercise to have /food/mexican/,  /food/french/, /food/japanese/ and serve an example food for each one.
Arrange your code so the paths can be changed to /cuisine/mexican/,  /cuisine/french/, and /cuisine/japanese/ by changing a single http:location definition.
Hint, use <code>http_absolute_uri/2</code></p></div>
<div class="paragraph"><p>EXERCISE:
Move a handler, use the make command, then try to access the old location. It may work until you restart.
Lesson learned - restart after you muck with location.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_moving_the_whole_shebang">3.5. Moving the whole shebang</h3>
<div class="paragraph"><p>Your server will some day probably be proxied to by apache, so your root path may be changed. You can change all abstract paths at once by redefining the setting http:prefix.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise
Change the setting and confirm it works</p></div>
<div class="paragraph"><p>Question</p></div>
<div class="paragraph"><p>Does it still serve at the old location?</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_file_path_aliases">3.6. File Path Aliases</h3>
<div class="paragraph"><p>SWI-Prolog has an abstract file path system - you&#8217;ve seen it when you include modules with</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(http/html_write)).</code></pre>
</div></div>
<div class="paragraph"><p><code>library</code> is an abstract file path, also known as a <em>path alias</em>.</p></div>
<div class="paragraph"><p>Various places in the web framework refer to files, so I&#8217;m covering this material now.</p></div>
<div class="paragraph"><p>Just as hard coded URI&#8217;s become painful as a site grows larger, hard coded file paths become painful.</p></div>
<div class="paragraph"><p>Developers can define additional file search paths. For example, you might have a project flubbercalc you bring into your project as a git submodule. You&#8217;d like to have those files look like part of the available libraries.</p></div>
<div class="paragraph"><p>Add a clause to the multifile predicate <code>user:file_search_path/2</code> for it.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user:file_search_path(library, './flubbercalc').</code></pre>
</div></div>
<div class="paragraph"><p>You can also add your own paths. Say you have a file of videos you serve.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user:file_search_path(videos, './videos').</code></pre>
</div></div>
<div class="paragraph"><p>Unlike URI locations, path aliases can be defined in terms of other aliases</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user:file_search_path(videos, './videos').
user:file_search_path(kiddy, videos(children)).</code></pre>
</div></div>
<div class="paragraph"><p>Say you have two sources of kiddy videos you purchased from different distributors, movietime and moviola. For some purposes you need them separate, but you want to be able to refer to all of them as if they&#8217;re in one directory at times.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user:file_search_path(videos, './videos').
user:file_search_path(kiddy, videos(children/movietime)).
user:file_search_path(kiddy, videos(children/moviola)).</code></pre>
</div></div>
<div class="paragraph"><p>If this system is being your enemy instead of your friend, you can debug with the Prolog flag verbose_file_search. Setting it to true makes the system print out the absolute paths each time it resolves a file name. You can also directly query expand_file_search_path and see all the matches of a spec.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_html">4. Generating HTML</h2>
<div class="sectionbody">
<div class="paragraph"><p>So far we&#8217;ve served plain text. Lets serve HTML.</p></div>
<div class="paragraph"><p>This is the longest chapter in the tutorial. I&#8217;m approaching it from the bottom up, so don&#8217;t panic until we cover <code>html//1</code> if the HTML generation looks ugly.</p></div>
<div class="sect2">
<h3 id="_two_camps">4.1. Two Camps</h3>
<div class="paragraph"><p>There are two camps when it comes to HTML generation.</p></div>
<div class="paragraph"><p><span class="image">
<img src="twocamps-01.png" alt="Well, for Prolog there are three camps - us unemployed, broke, homeless Prolog programmers have our own camp down by the railroad tracks" />
</span></p></div>
<div class="paragraph"><p>The <em>template</em> camp wants to edit HTML with normal HTML tools, and will live with awkward php/jsp/asp style <code>&lt;% &#8230;. %&gt;</code> escaping for dynamic generation.</p></div>
<div class="paragraph"><p>The dynamic camp wants to dynamically generate web pages, and will live with an idiomatic <em>funny looking</em> HTML representation for the convenience of mixing code and HTML easily.</p></div>
<div class="sect3">
<h4 id="_options">4.1.1. Options</h4>
<div class="paragraph"><p>In SWI-Prolog you have several options:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
simple-template
</dt>
<dd>
<p>
   Simple-template by Raivo Laanemets (installable as a pack, or at <a href="https://github.com/rla/simple-template">https://github.com/rla/simple-template</a> ) enforces the strictest separation of logic and formatting. Simple-template doesn&#8217;t allow prolog code in the template.
</p>
</dd>
<dt class="hdlist1">
Prolog Web Pages
</dt>
<dd>
<p>
   PWP is the most asp/jsp like, with the advantage that it&#8217;s well formed XML. <a href="http://www.cs.otago.ac.nz/staffpriv/ok/pwp.pl">http://www.cs.otago.ac.nz/staffpriv/ok/pwp.pl</a>
</p>
</dd>
<dt class="hdlist1">
<code>html//1</code>
</dt>
<dd>
<p>
   Prolog syntax DCG based HTML generation. Part of the SWI-Prolog distribution.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>This chapter is about the built in SWI-Prolog HTML generation support using <code>html//1</code>, which is firmly in the <em>dynamic</em> camp. PWP and Raivo&#8217;s simple-template systems both have excellent documentation. I see no point in repeating them here.</p></div>
<div class="paragraph"><p>If you pitch your tent in the template camp, SWI-Prolog provides support for it <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%283,%273.21%27,swi%28%27/doc/packages/http.html%27%29%29">integrating PWP</a> .</p></div>
<div class="paragraph"><p>But both sides of the debate have merit. Templates are great for working with a web designer, and of course the toolchain for normal HTML is far better developed. Separating function and appearance is a good thing to do, especially if you&#8217;ll be using the code for more than one website.</p></div>
<div class="paragraph"><p>On the other hand, modern web applications seem to make almost everything on the page dynamic. On the SWI-Prolog.org website, for example, even Owlie the owl icon is dynamic (he changes on holidays). If you&#8217;re generating tiny bits of HTML automatically, templates can become a nightmare.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">As an aside, if you like the whole WordPress style <em>they write most of the application for me</em> framework, check out Raivo Laanemets' <a href="http://blog-core.net/">Blog-Core</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_combining_options">4.1.2. Combining Options</h4>
<div class="paragraph"><p>Fortunately, this is a false dicotomy. It&#8217;s easy to integrate the systems.</p></div>
<div class="paragraph"><p>That said, you can indeed output a block of <em>normal</em> HTML with the built-in support. Some strategies for doing so (skipping ahead a bit):</p></div>
<div class="ulist"><ul>
<li>
<p>
Use the html quasiquoter. You can write some normal HTML and say to SWI-Prolog <em>turn this stuff into your dynamic representation</em>.
</p>
</li>
<li>
<p>
Include bits of <em>normal</em> HTML in an otherwise dynamic page by using the inclusion mechanism described under <em>inclusion</em> in 2_6
</p>
</li>
<li>
<p>
Serve entire static pages (eg. a terms of service page) using the file serving mechanisms described in 6_1
</p>
</li>
<li>
<p>
Use print_html/1 to generate tokenized HTML dynamically, then insert it in simple-template using <code>{{- expression }}</code>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_directly_printing_html">4.2. Directly printing HTML</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Direct Printing example</div>
<div class="paragraph"><p>See file direct_print.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>We can serve HTML just by printing it.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(_Request) :-
        format('Content-type: text/html~n~n'),
                format('&lt;html&gt;&lt;head&gt;&lt;title&gt;Howdy&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h2&gt;A Simple Web Page&lt;/h2&gt;&lt;p&gt;With some text.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;~n').</code></pre>
</div></div>
<div class="paragraph"><p>Ouch!</p></div>
<div class="paragraph"><p>Clearly we&#8217;re not doing this for long. But it&#8217;s nice to know you can just print if the handy helper stuff is fighting you.</p></div>
</div>
<div class="sect2">
<h3 id="_using_print_html">4.3. Using print_html</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Using print_html example</div>
<div class="paragraph"><p>See file print_html_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This isn&#8217;t any better, but is an important step in understanding.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content"><strong>Don&#8217;t</strong> do this in your own code.</td>
</tr></table>
</div>
<div class="paragraph"><p><code>print_html</code> is a behind the scenes predicate that converts a list of HTML chunks into a string containing HTML. Besides just concatenating, it inserts some rough formatting.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(_Request) :-
        format('Content-type: text/html~n~n'),
    print_html(
    ['&lt;html&gt;',
     '&lt;head&gt;',
     '&lt;title&gt;',
     'Howdy',
     '&lt;/title&gt;',
     '&lt;/head&gt;',
     '&lt;body&gt;',
     '&lt;h2&gt;',
     'A Simple Web Page',
     '&lt;/h2&gt;',
     '&lt;p&gt;',
     'With some text.',
     '&lt;/p&gt;',
     '&lt;/body&gt;',
     '&lt;/html&gt;']).</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_representing_html">4.4. Representing HTML</h3>
<div class="paragraph"><p>SWI-Prolog has 3 representations for HTML. It can be a single atom, like in 2_1, or a list of tokens, (tokenized html), or a term form (termerized html) that we&#8217;ll show next. Keeping track of which form you&#8217;re working with can be one of the more confusing bits. So I&#8217;m introducing some terminology that Jan doesn&#8217;t use in the SWI-Prolog documentation.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>HTML atom</strong>
</dt>
<dd>
<p>
   an atom or string with HTML in it (the 2_1 representation)
</p>
</dd>
<dt class="hdlist1">
<strong>Tokenized HTML</strong>
</dt>
<dd>
<p>
   The stuff above
</p>
</dd>
<dt class="hdlist1">
<strong>Termerized HTML</strong>
</dt>
<dd>
<p>
   The stuff we&#8217;ll show in 2_3
</p>
</dd>
</dl></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Look at output</div>
<div class="paragraph"><p>EXERCISE:
Run print_html_example and look at the generated HTML.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_html_1_and_termerized_html">4.5. html//1 And Termerized HTML</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">HTML DCG example</div>
<div class="paragraph"><p>See file html_dcg_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The primary tool for generating HTML in real applications is <code>html//1</code>, a DCG that takes an argument that defines some html using a domain specific language we call <em>Termerized HTML</em>.</p></div>
<div class="paragraph"><p><span class="image">
<a class="image" href="/swipltuts/clpfd/clpfd.html">
<img src="comfy.png" alt="He&#8217;s just read my DCG tutorial, that&#8217;s why he looks like that" width="244" />
</a>
</span></p></div>
<div class="paragraph"><p>Finally, we see something that looks like reasonable HTML generation.</p></div>
<div class="paragraph"><p>Web pages are nested structures of boxes within boxes and areas on a page. While they have a strong structural similarity to their HTML representation, they are not identical. A search box is not, conceptually, just a text field, but is a thing unto itself.</p></div>
<div class="paragraph"><p>Representing the <em>page&#8217;s</em> structure and converting it to a list of HTML chunks is list generation, and there&#8217;s a natural tool in Prolog for list generation - the DCG.</p></div>
<div class="paragraph"><p>That&#8217;s what SWI-Prolog does, in a sorta sideways way. Here&#8217;s an example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    phrase(
        html(
        [head(title('Howdy')),
         body([h1('A Simple Web Page'),
              p('With some text')])
            ]),
        TokenizedHtml,
        []),</code></pre>
</div></div>
<div class="paragraph"><p>Notice that we&#8217;re using <code>phrase/2</code>. <code>phrase</code><em>s first argument is a library DCG, <code>html//1</code>, whose argument is a DSL (domain specific language) which defines the HTML it recognizes. So, phrase/2 will unify in the above when <code>TokenizedHtml</code> is the tokenized HTML equivalent of the red stuff, the 'termerized HTML</em> defined by the first arg of <code>html//1</code>.</p></div>
<div class="paragraph"><p>It is this DSL which is our <em>termerized HTML</em>.</p></div>
</div>
<div class="sect2">
<h3 id="_proving_it_8217_s_a_real_dsl">4.6. Proving it&#8217;s a real DSL</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Real DCG example</div>
<div class="paragraph"><p>See file real_dcg.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Using a DCG just to call <code>html//1</code> and passing it the termerized HTML probably seems, at this point, pretty Rube Goldberg-ish. When we get to inclusions you&#8217;ll see why it&#8217;s done.</p></div>
<div class="paragraph"><p>Lets prove that it&#8217;s a real DCG by abstracting out the generation into it&#8217;s own nonterminal (See the file).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(_Request) :-
        phrase(
            my_nonterm,
            TokenizedHtml,
            []),
        format('Content-type: text/html~n~n'),
        print_html(TokenizedHtml).

my_nonterm --&gt;
    html([html([head([title('Howdy')]),
               body([h1('A Simple Web Page'),
              p('With some text')])])]).</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_reply_html_page">4.7. reply_html_page</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title"><code>reply_html_page</code> example</div>
<div class="paragraph"><p>See file reply_html_page_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Generating our own head and body tags is more ceremony than we really need. SWI-Prolog provides a nice wrapper that takes care of the boilerplate, and in the process handles a lot of other behind the scenes work. Notice it&#8217;s handled the Content-type header for us.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(_Request) :-
    reply_html_page(
       [title('Howdy')],
       [h1('A Simple Web Page'),
        p('With some text')]).</code></pre>
</div></div>
<div class="paragraph"><p>We&#8217;re down to a single API call that takes some termerized HTML to include in the head and the contents of the body, which is pretty close to zero ceremony.</p></div>
<div class="paragraph"><p>(If you&#8217;re paniced and thinking <em>oh, man, I don&#8217;t control the head?</em>, relax - you do, we&#8217;ll get there when we cover the arity 3 version <code>reply_html_page/3</code> in a bit.)</p></div>
</div>
<div class="sect2">
<h3 id="_termerized_html_syntax">4.8. Termerized HTML Syntax</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title"><code>termerized_html</code> example</div>
<div class="paragraph"><p>See file termerized_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Now we&#8217;re ready to look at the termerized HTML syntax. You&#8217;ll definitely want to have termerized_example.pl open in front of you as you read this.</p></div>
<div class="paragraph"><p>The SWI-Prolog docs for this are in <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%283,%273.17%27,swi%28%27/doc/packages/http.html%27%29%29">this location</a> (which I recommend bookmarking, as finding it is always exciting).</p></div>
<div class="paragraph"><p>Termerized HTML uses an arity 1 or 2 term for each HTML tag.</p></div>
<div class="paragraph"><p>The arg of arity 1 terms is the innerHTML. The args of arity 2 terms are attributes and innerHTML. Either one can be a list to allow multiple items.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(_Request) :-
    reply_html_page(
       [title('Howdy')],
       [
        h1('A Simple Web Page'),  % arity 1
        p(class=bodytext, 'With some text'),  % arity 2
        p([class=bodytext, style='font-size: 120%'], ['Bigger text', b('some bold')])
        ]).</code></pre>
</div></div>
<div class="paragraph"><p>The html//1 term takes a term or a list as it&#8217;s sole argument, in the same format at the innerHTML argument of tag term</p></div>
<div class="sect3">
<h4 id="_here_8217_s_most_of_the_forms_you_can_apply">4.8.1. Here&#8217;s most of the forms you can apply:</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">One form you <strong>won&#8217;t</strong> see is a nested list.  <code>[p(<em>a para</em>), [p(<em>in a nested list</em>)]]</code> is <strong>not</strong> valid termerized HTML. You&#8217;ve been warned.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_inner_html">4.8.2. Inner HTML</h4>
<div class="paragraph"><p>A simple headline with plain text inside it</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    h1('A Simple Web Page'),</code></pre>
</div></div>
<div class="paragraph"><p>A bold paragraph</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    p(b('some bold text'))</code></pre>
</div></div>
<div class="paragraph"><p>If it&#8217;s a list, the items are converted individually and concatenated.</p></div>
<div class="paragraph"><p>A div block with two paragraphs</p></div>
<div class="listingblock">
<div class="content">
<pre><code>div([p('a para'), p('another para')])</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_entities">4.8.3. Entities</h4>
<div class="paragraph"><p>entity escaping happens</p></div>
<div class="listingblock">
<div class="content">
<pre><code>p('&lt;b&gt;this wont be bold&lt;/b&gt;')</code></pre>
</div></div>
<div class="paragraph"><p>appears literally, not in bold.</p></div>
<div class="paragraph"><p>If you need an entity you can name one</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&amp;(copy)</code></pre>
</div></div>
<div class="paragraph"><p>gives a copyright symbol</p></div>
<div class="listingblock">
<div class="content">
<pre><code>p(['Copyright ', &amp;(copy), ' 2012, Anne Ogborn'])</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_string_help">4.8.4. String Help</h4>
<div class="paragraph"><p>There&#8217;s much help to perform string operations. You can get <code>format/2</code> style formatting using -</p></div>
<div class="listingblock">
<div class="content">
<pre><code>p('these ~d things, faith, hope, and love. But the greatest of them is ~w'-[3,love])</code></pre>
</div></div>
<div class="paragraph"><p>Concatenation usually isn&#8217;t needed, but is<br /></p></div>
<div class="listingblock">
<div class="content">
<pre><code>p('two strings'+'two strings')</code></pre>
</div></div>
<div class="paragraph"><p>would usually be expressed</p></div>
<div class="listingblock">
<div class="content">
<pre><code>p(['two strings', 'two strings')</code></pre>
</div></div>
<div class="paragraph"><p>Though the first doesn&#8217;t leave a space between them</p></div>
</div>
<div class="sect3">
<h4 id="_attributes">4.8.5. Attributes</h4>
<div class="paragraph"><p>This paragraph has a style and tooltip text.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>p([style='font-size: 36pt', title='tooltip text'], 'With some text'),</code></pre>
</div></div>
<div class="paragraph"><p>If there&#8217;s a single attribute the list can be omitted</p></div>
<div class="listingblock">
<div class="content">
<pre><code>p(class=foo, 'some text')</code></pre>
</div></div>
<div class="paragraph"><p>Notice that SWI-Prolog will put the quotes around foo in the HTML. As always in Prolog you have to quote atoms with iffy chars in them, like the src and alt attributes below.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>img([src='obama.png', class=pres, height=128, width=128, alt='Barack Hussain Obama'], [])</code></pre>
</div></div>
<div class="paragraph"><p>Attributes have an even more extensive set of helper operators.</p></div>
<div class="paragraph"><p>Attributes can be specified by K=V pairs like <code>class=foo</code> or by K(V) terms like <code>class(foo)</code>. The latter form is useful for avoiding operator priority worries</p></div>
<div class="paragraph"><p>Concatenate like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>class=alert+AlertLevel</code></pre>
</div></div>
<div class="paragraph"><p>Format strings like <code>format/2</code> go like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>alt='Image of ~w'-[Subject]</code></pre>
</div></div>
<div class="paragraph"><p>+List produces a query string with proper urlencoding</p></div>
<div class="listingblock">
<div class="content">
<pre><code>href='mep.php?'+[name=Name, email=Email, sex=Sex]</code></pre>
</div></div>
<div class="paragraph"><p>This urlencodes an arbitrary atom or string</p></div>
<div class="listingblock">
<div class="content">
<pre><code>href='http://example.com/foo.php?msg='+encode(MyMessage)</code></pre>
</div></div>
<div class="paragraph"><p>Later we&#8217;ll cover another way of specifying a handler, by ID. This syntax creates a URL from a location ID.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>href=location_by_id(ID)  % treated later</code></pre>
</div></div>
<div class="paragraph"><p>A list not interpretable as right side of operator is joined with spaces. This is useful for multiple class lists.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>class=[emphasize, left, question]</code></pre>
</div></div>
<div class="paragraph"><p>becomes</p></div>
<div class="listingblock">
<div class="content">
<pre><code>class="emphasize left question"</code></pre>
</div></div>
<div class="paragraph"><p>This bit about namespaces is slightly esoteric, feel free to skip down to the next exercises if not of interest.</p></div>
<div class="paragraph"><p>Attributes in other namespaces look like this. This is fairly rare in html, it shows up when mixing in XML or RDF related stuff. Here we have elgin:advisory. Note that, surprisingly, HTML5 doesn&#8217;t "know" about namespaces, and adding them to the html tag is invalid. Colon is a normal character in attributes in HTML5.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>html(div([class(Classes), elgin:advisory(ToolSet)],
     [img([class('el-tool-image'), elgin:advisory(ToolSet), alt(Alt), title(Alt), src(Image)]),
     \subtools(ToolSet)]
    )).</code></pre>
</div></div>
<div class="paragraph"><p>If you&#8217;re in XHTML dialect you can add namespaces with <code>xhtml_ns//2</code>. By default SWI-Prolog puts out HTML5. To put out XHTML do</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    html_set_options([dialect(xhtml)])</code></pre>
</div></div>
<div class="paragraph"><p>This section&#8217;s certainly long, but it&#8217;s the core of the tutorial. Still, lets break and do a few exercises to absorb what we&#8217;ve learned.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">html exercises</div>
<div class="paragraph"><p>Exercise:
Convert a simple web page from a project you&#8217;ve made into termerized HTML.</p></div>
<div class="paragraph"><p>Build your own example of each element in this section</p></div>
</div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inclusion">5. Inclusion</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title"><code>termerized_html</code> example</div>
<div class="paragraph"><p>This section also uses file termerized_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>HTML is a markup language. It&#8217;s tags are not the semantic units of a web page as we think about it. We want to talk about the login box, not a div with a text box blah blah. Inclusion is SWI-Prolog&#8217;s mechanism for encapsulating HTML generation code. This means you can create structured, reusable components of web pages, and pays off many times the slight awkwardness of <em>funny looking html</em>.</p></div>
<div class="paragraph"><p>Inclusion is signaled by <code>\</code>. If the argument of \ is a term, it will be treated as a DCG, and expanded to tokenized HTML.</p></div>
<div class="paragraph"><p>The line</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    \some_included_stuff,</code></pre>
</div></div>
<div class="paragraph"><p>Calls the DCG</p></div>
<div class="listingblock">
<div class="content">
<pre><code>some_included_stuff --&gt;

    html([p('Some included stuff')]).</code></pre>
</div></div>
<div class="paragraph"><p>Of course you can pass semantic arguments</p></div>
<div class="listingblock">
<div class="content">
<pre><code>\more_included_stuff('Whoop Whoop!'),</code></pre>
</div></div>
<div class="paragraph"><p>&#8230;which calls&#8230;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>more_included_stuff(X) --&gt;

    html([p(['More included stuff: ', b(X)])]).</code></pre>
</div></div>
<div class="paragraph"><p>Notice you&#8217;re back in tokenized HTML space (and in Prolog). You need <code>html//1</code> here.</p></div>
<div class="paragraph"><p>You only need <code>html//1</code> when it&#8217;s time to make literal HTML. Nothing wrong with</p></div>
<div class="listingblock">
<div class="content">
<pre><code>included_stuff(X) --&gt;
    another_inclusion(X),
    and_a_third_inclusion(X).</code></pre>
</div></div>
<div class="paragraph"><p>Included lists are treated as literal, tokenized HTML to be included. So, you can include a block of HTML set up with a normal editor</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    \['&lt;i&gt;in italic&lt;/i&gt;', '&lt;b&gt;now we have bold&lt;/b&gt;'],</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">If you do this you can&#8217;t depend on <code>html//1</code> always producing valid HTML. For this reason, seriously consider using quasiquotes instead. Quasiquotes largely deprecate this mechanism.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">The list brackets for including a literal are not optional! <code>\[term]</code> and <code>\term</code> are completely different. The first puts &lt;i&gt;term&lt;/i&gt; in the html. The second treats term as an inclusion.</td>
</tr></table>
</div>
<div class="paragraph"><p>A useful way of thinking about inclusion is that \ is an escape that says, in effect <em>enter tokenized HTML world</em>. \</p></div>
<div class="paragraph"><p>Inclusion is simultaneously one of the neatest features of SWI-Prolog web, and one of the greatest sources of frustrating bugs.</p></div>
<div class="paragraph"><p>The secrets to avoid driving yourself insane with inclusion are, first, understand whether you&#8217;re in termerized HTML or tokenized HTML space. Second, be aware you aren&#8217;t in prolog, and need to follow the DSL&#8217;s, not Prolog&#8217;s, module rules.</p></div>
<div class="sect2">
<h3 id="_quasiquotes">5.1. Quasiquotes</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Quasiquotes example</div>
<div class="paragraph"><p>This section uses file quasiquotes_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>At this point those of you in the template camp are probably running in circles, screaming and shouting, thinking that the only escape from Jan&#8217;s strange formatting for html is to abandon ship and use simple-template, or ignore the warnings liberally plastered about the <code>\[ ]</code> format.</p></div>
<div class="paragraph"><p>Have no fear, quasiquotes are here.</p></div>
<div class="paragraph"><p>Quasiquotes are an extension to the Prolog syntax that says, effectively <strong>"and now for a little of this other language, which I&#8217;ll syntax check and convert at compile time to a Prolog term"</strong>.</p></div>
<div class="paragraph"><p>Here&#8217;s demo of the html quasiquoter in use. We import html_write to get the appropriate quasiquoter (html in this case) and then use <code>{|html(Y)||&lt;p&gt;Y&lt;/p&gt;|}</code>, the curly brackets and or bars defining "this is a quasiquoter, here&#8217;s the args and body". <code>html(Y)</code> defines the args to be passed in (notice that it&#8217;s not like function argument passing, the name can&#8217;t be changed like with a formal arg on a function), and inside is the body, which is syntax checked, and Y is replaced.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>2 ?- use_module(library(http/html_write)).
true.

3 ?- Y=7,X = {|html(Y)||&lt;p&gt;Y&lt;/p&gt;|}.
Y = 7,
X = [element(p, [], [7])].

4 ?-</code></pre>
</div></div>
<div class="paragraph"><p>Just the thing for us. Now we have syntax checking, editor coloring, and aren&#8217;t in the wild west of converting between html and strings.</p></div>
<div class="paragraph"><p>Here&#8217;s what it looks like inside of a DCG inclusion:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>my_headline(X) --&gt;
        html({|html(X)||&lt;h1&gt;X&lt;/h1&gt;|}).</code></pre>
</div></div>
<div class="paragraph"><p>Notice we&#8217;ve passed it to <code>html//1</code>. That&#8217;s usually what you&#8217;ll do with it.</p></div>
<div class="paragraph"><p>But what&#8217;s it compile into?
The SWI-Prolog docs say</p></div>
<div class="quoteblock">
<div class="title"><code>html/4</code> Quasiquote output format</div>
<div class="content">
<div class="paragraph"><p>These quotations produce a DOM term that is suitable for html//1 and other predicates that are declared to consume this format.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>?- use_module(library(http/html_write)).
true.

4 ?- X = hello,Y = {|html(X)||&lt;h1&gt;X&lt;/h1&gt;|}.
X = hello,
Y = [element(h1, [], [hello])].

5 ?- Y = {|html(X)||&lt;h1&gt;X&lt;/h1&gt;|}.
Y = [element(h1, [], [X])].</code></pre>
</div></div>
<div class="paragraph"><p>The funny list with element/3 term in it is the format SWI-Prolog represents SGML in. But usually you won&#8217;t care about that.</p></div>
<div class="paragraph"><p>If you want to insert some normal HTML boilerplate in the midst of a mass of termerized html, do it like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>my_inclusion(X) --&gt;
        html([
          p('termerized para'),
          \html({|html(X)||&lt;p&gt;X&lt;/p&gt;|})
          ]).</code></pre>
</div></div>
<div class="paragraph"><p>Admittedly slightly verbose.</p></div>
</div>
<div class="sect2">
<h3 id="_inclusion_and_modules">5.2. Inclusion And Modules</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Inclusion and Modules Example</div>
<div class="paragraph"><p>This section also uses file termerized_example.pl and anothermodule.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><span class="image">
<img src="comfymodule-01.png" alt="His coffee&#8217;s gone cold" width="244" />
</span></p></div>
<div class="paragraph"><p>Now that you can make nifty bits of pages, you start accumulating them and soon you have enough you need to organize into modules. You use the usual use_module system and life is good for a while.</p></div>
<div class="paragraph"><p>Then you get this bright idea. You could make your site look really awesome by using Javascript and HTML5 to draw a <em>hand drawn</em> border around the various sections. But now we want to add the <em>hand drawn</em> look without having a mess everywhere. We could do:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        start_hand_drawn_box, ... contents, \end_hand_drawn_box</code></pre>
</div></div>
<div class="paragraph"><p>but that&#8217;s ugly - it doesn&#8217;t express the containment structure.</p></div>
<div class="paragraph"><p>So we write an inclusion DCG that takes some termerized html as an argument and adds the html around it to make the hand drawn look.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>hand_drawn_box(InnerHTML) --&gt;
      html([.... whole bunch of crazy javascript stuff...,
                 div(class=hand, InnerHTML),
            ... more totally unreadable javascript ... ]).</code></pre>
</div></div>
<div class="paragraph"><p>We try this, and, after debugging the ugly javascript, it works. Cool! So, being organized, we move it into it&#8217;s own module. And suddenly it fails when we try this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%in module1
  email_me_form --&gt;
        html([div(class=emailme, form(.... mass of form code ...))]).

  my_contents --&gt;
        html([... stuff...,
           \hand_drawn_box([... stuff...,   \email_me_form,  ...]),
           ... endless stuff ...]).

%in module2
  hand_drawn_box(InnerHTML) --&gt;
      html([.... whole bunch of crazy javascript stuff...,
                 div(class=hand, InnerHTML),
            ... more totally unreadable javascript ... ]).</code></pre>
</div></div>
<div class="paragraph"><p>And it complains it doesn&#8217;t know about module2:email_me_form//0 -  Ooops! hand_drawn_box is binding it&#8217;s arguments at the wrong time!</p></div>
<div class="paragraph"><p>The same thing can happen in <em>normal</em> Prolog code. The fix there is the <code>meta_predicate/1</code> declaration, which marks which arguments are <em>module sensitive</em>. Module sensitive arguments have their module resolved before the call. Unfortunately, we&#8217;re not in Prolog, we&#8217;re in termerized HTML DSL language.</p></div>
<div class="paragraph"><p>Fortunately there&#8217;s an extension to meta_predicate that handles html. <code>html_meta</code> works like meta_predicate, but allows html as well as the usual :, ?, +, -, etc. At compile time, the termerized HTML gets module extended in the context of the caller, and Bob&#8217;s yer uncle.</p></div>
<div class="paragraph"><p>Now we can make an inclusion that takes html:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%in module2

:- html_meta  hand_drawn_box(html,?,?).

  hand_drawn_box(InnerHTML) --&gt;
      html([.... whole bunch of crazy javascript stuff...,
                 div(class=hand, InnerHTML),
            ... more totally unreadable javascript ... ]).</code></pre>
</div></div>
<div class="paragraph"><p><code>hand_drawn_box</code> takes termerized HTML as it&#8217;s first argument. Remember that it&#8217;s a DCG, so there are two additional arguments for the difference list, hance the two ? arguments.</p></div>
<div class="paragraph"><p>Besides fixing the module issue, the pceEmacs editor will now properly syntax color the argument.</p></div>
<div class="paragraph"><p>This works great as long as you&#8217;re passing termerized html around. Imagine things are even worse - say you&#8217;re passing a list containing various html hunks to an inclusion, and it&#8217;s supposed to include one based on some other criteria. We can&#8217;t use <code>html_meta/1</code>.</p></div>
<div class="paragraph"><p>The solution is to explicitly specify the module of the inclusions. Remember, you&#8217;re <strong>not in Prolog</strong>, but <strong>in the DSL</strong>, so you have to use the DSL&#8217;s module rules. So you&#8217;ll need to do this for inclusions from the calling module, not just from other modules.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>\(othermodule:inclusion(X))</code></pre>
</div></div>
<div class="paragraph"><p>Operator precedence makes the parens necessary.</p></div>
<div class="paragraph"><p>I would say, module issues are, along with inclusion, the great pain points in using the web framework.  Don&#8217;t go past this point without understanding the module system, <code>meta_predicate</code>, <code>meta_html</code>, and how inclusion works.</p></div>
<div class="sect3">
<h4 id="_start_a_project">5.2.1. Start A Project</h4>
<div class="paragraph"><p>At this point our exercises start building on each other. You may want to copy one of the examples to create a starting point.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Create a simple web page with a form that does a GET to gather a message. You needn&#8217;t build anything to handle the form.</p></div>
<div class="paragraph"><p>Exercise: Encapsulate the form in a separate DCG so it can be reused.</p></div>
<div class="paragraph"><p>Exercise: Create a DCG motd//0 that shows the MOTD or other dynamic data as an inclusion. Add it to your page.</p></div>
<div class="paragraph"><p>Exercise: create a DCG my_fancy_border//1 whose argument is termerized HTML representing what&#8217;s inside the border. Make it surround the passed HTML with a div with some fancy border. (for now use a style= attribute in the div, since we haven&#8217;t covered stylesheet inclusion).</p></div>
<div class="paragraph"><p>Use it to style the MOTD block. Also use it to style the web form.</p></div>
<div class="paragraph"><p>Exercise: Perform these refactorings:</p></div>
<div class="paragraph"><p>Add a module declaration to your code.</p></div>
<div class="paragraph"><p>Create a second module, and move my_fancy_border into it.</p></div>
<div class="paragraph"><p>Move  motd//0 to a third module.</p></div>
<div class="paragraph"><p>Exercise: Make a DCG random_saying that takes a list whose elements are termerized HTML snippets</p></div>
<div class="paragraph"><p>and includes a random one. Put it in it&#8217;s own module. call it from another module. Now wrap your choices in fancy_border.</p></div>
</div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_styling">6. Styling</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Styling example</div>
<div class="paragraph"><p>This section uses file styling_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Until now our web pages have looked pretty last century. To boot, we get no help adding the common elements across all pages. Lets spiff things up.</p></div>
<div class="paragraph"><p>Corporate wants every page to say <em>The Simple Web Page Site</em> across the top of every page. It&#8217;s a common requirement. Why should we repeat that for each page?</p></div>
<div class="paragraph"><p><code>reply_html_page</code> has an arity 2 and an arity 3 form. The arity 3 version saves us</p></div>
<div class="listingblock">
<div class="content">
<pre><code>say_hi(Request) :-
    reply_html_page(
        tut_style,   % define the style of the page
       [title('Howdy')],
        [\page_content(Request)]).</code></pre>
</div></div>
<div class="paragraph"><p>this declares to SWI-Prolog&#8217;s innerds that it should apply <em>tut_style</em> to this page.</p></div>
<div class="paragraph"><p>To define <code>tut_style</code>, we need to define a hook</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- multifile
        user:body//2.

% Body will be included
user:body(tut_style, Body) --&gt;
        html(body([ div(id(top), h1('The Simple Web Page Site')),
                    div(id(content), Body)
                  ])).</code></pre>
</div></div>
<div class="paragraph"><p>Observation here - what&#8217;s coming in is <strong>tokenized</strong> HTML.</p></div>
<div class="sect2">
<h3 id="_user_head">6.1. user:head</h3>
<div class="paragraph"><p>You can do the same thing with the head. Add a hook predicate for user:head. This is a possible, but rarely the best, method of including Javascript and CSS. More often, it&#8217;s a great way to get things like the title and keywords set up.</p></div>
<div class="paragraph"><p>Of course you can have more than one style. At my employer we use one style for content to be viewed on the web and one style for content to be viewed in the virtual world.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise:
Add a header and footer to your web page from the <code>html//1</code> exercises using body styling.</p></div>
<div class="paragraph"><p>Exercise:
Make a pair of web pages that have some main content and some <em>ads</em> (feel free to just make a div and some text for the ads) served from /free  and the same content without ads served from /paid. Minimize repeated code.</p></div>
<div class="paragraph"><p>Exercise (small project):
Metadata like keywords is often treated as <em>somebody elses job</em> by both web designers and engineers. For an explanation of the HTML META element, see <a href="https://en.wikipedia.org/wiki/Meta_element">https://en.wikipedia.org/wiki/Meta_element</a></p></div>
<div class="paragraph"><p>Build a few simple pages that share a style, imagining this could be a large, complex web application.</p></div>
<div class="paragraph"><p>Now add a module that makes adding proper keywords to the pages easy. The system should, at minimum, collect a set of keywords that appear on every page, plus a set of per-page specific keywords and enforce that this information is provided for every page. Handle keywords and description attributes.</p></div>
<div class="paragraph"><p>Other useful features would include allowing definition of <em>topics</em> that recursively expand to keywords, handling robot exclusion, the robot attribute, and keyword omission for pages that should not be indexed.</p></div>
<div class="paragraph"><p>One important consideration is enforcing that the metadata gets entered for every page. Imagine this project is being done by a small company, and consider what the workflow will be. When a page is added to the site, it should trigger some process that results in a human adding the appropriate keywords. Consider how you will enter the actual keywords. Think about larger software engineering issues. For example, this might be the responsibility of someone nontechnical who maintains a CSV file via a spreadsheet, or it might simply throw when the keywords are missing, inducing the developer to add them.</p></div>
<div class="paragraph"><p>The relative transparency of how the framework works encourages this sort of useful separation of concerns, an advantage of a more expressive language like SWI-Prolog.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_mailman">6.2. Mailman</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Mailman Example</div>
<div class="paragraph"><p>This section uses file mailman_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%284,%273.17.2%27,swi%28%27/doc/packages/http.html%27%29%29'">Mailman</a> is a facility for creating HTML that ultimately ends up somewhere besides where you generated it. It has nothing to do with email.</p></div>
<div class="paragraph"><p>We&#8217;re covering it with styling because it&#8217;s often used to place content in the head, but it has a lot of other uses.</p></div>
<div class="paragraph"><p>Often it&#8217;s a lot easier to generate a page in an order other than the final lexical order of the html.</p></div>
<div class="paragraph"><p>Suppose we have a page with a top navigation area that gets dynamicly generated. Being organized, we abstract the nav bar into an inclusion DCG.</p></div>
<div class="paragraph"><p>Early version - not like the example file</p></div>
<div class="listingblock">
<div class="content">
<pre><code>page_content(_Request) --&gt;
    html(
       [
        h1('Demonstrating Mailman'),
        div(\nav_bar),
        p('The body goes here')
       ]).

nav_bar --&gt;
    {
        findall(Name, nav(Name, _), ButtonNames),
        maplist(as_top_nav, ButtonNames, TopButtons)
    },
    html(TopButtons).</code></pre>
</div></div>
<div class="paragraph"><p>The web designer notices that many of our pages get long, and wants to add a small type version of the navigation at the bottom.</p></div>
<div class="paragraph"><p><span class="image">
<img src="addfooter-01.png" alt="No" />
</span></p></div>
<div class="paragraph"><p>We already have the list of buttons when we make the top menu. Can we avoid duplicating the work of making the list for the bottom?</p></div>
<div class="paragraph"><p>Mailman allows us to generate tokenized HTML in one place and <em>mail</em> it to another place, the <em>mailbox</em>, in the page.</p></div>
<div class="paragraph"><p>File mailman_example.pl sends the bottom buttons to the bottom with</p></div>
<div class="listingblock">
<div class="content">
<pre><code>\html_post(bottom_nav, BottomButtons)</code></pre>
</div></div>
<div class="paragraph"><p>and receives them with</p></div>
<div class="paragraph"><p><code>div(\html_receive(bottom_nav))</code></p></div>
<div class="listingblock">
<div class="content">
<pre><code>page_content(_Request) --&gt;
    html([
        h1('Demonstrating Mailman'),
        div(\nav_bar),
        p('The body goes here'),
        div(\html_receive(bottom_nav))
       ]).

nav_bar --&gt;
    {
    % we only need to find the ButtonNames once
        findall(Name, nav(Name, _), ButtonNames),
        maplist(as_top_nav, ButtonNames, TopButtons),
        maplist(as_bottom_nav, ButtonNames, BottomButtons)
    },
    html([\html_post(bottom_nav, BottomButtons) | TopButtons]).</code></pre>
</div></div>
<div class="paragraph"><p>A common reason to do this is a page element that in turn requires something in the head, say a widget that depends on a dynamic css or js snippet or dynamic keyword generation. In fact, the mailbox name <em>head</em> is always defined.</p></div>
<div class="paragraph"><p>Another common reason is an element (say a list of blog posts) whose contents are accumulated during page generation, and a set of links to them near the top of the page.</p></div>
<div class="paragraph"><p>Be aware, it&#8217;s possible to baffle it when mailing inclusions deep in other structures. You may need to use the <code>\(module:name(args))</code> form for any inclusions you mail. (if all you&#8217;re mailing is the inclusion, the system handles that).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise:
Add an inclusion call to your page that takes an argument which is displayed in the page title.</p></div>
<div class="paragraph"><p>Exercise:
Look at some project you&#8217;ve worked on that made a more or less complex dynamic page. Would it have been easier to code with mailman?</p></div>
<div class="paragraph"><p>Exercise (harder)
Many pre/non-jquery javascript libraries include some javascript snippet that should appear at the bottom of the page (so it runs after the page loads).
Set up a way in your project that inclusions that need such a snippet can send them without the widget user having to remember.</p></div>
<div class="paragraph"><p>Exercise
Use the debugger to look at what comes into your overload of user:body and user:head when you are using mailman.</p></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handling_parameters">7. Handling Parameters</h2>
<div class="sectionbody">
<div class="paragraph"><p>By now you&#8217;re probably itching to make something real. With parameters, we can start getting dynamic.</p></div>
<div class="sect2">
<h3 id="_code_http_parameters_code">7.1. <code>http_parameters</code></h3>
<div class="paragraph"><p><span class="image">
<img src="snake-handlers.jpg" alt="Django dev. Bitten by an implicit join 30 seconds after this picture was taken. Has no problem handling parameters in SWI-Prolog." width="192" />
</span></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Parameter example</div>
<div class="paragraph"><p>This section uses file parameter_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This section is about the pred http_parameters, documented at <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%283,%273.9%27,swi%28%27/doc/packages/http.html%27%29%29">this page</a>.</p></div>
<div class="paragraph"><p>The documentation is actually quite good, so I&#8217;m going to refer you there for parameter handling, but tell you about some gotchas.</p></div>
<div class="paragraph"><p>Gotcha #1: If a parameter is missing or invalid it doesn&#8217;t fail, it throws an exception.</p></div>
<div class="paragraph"><p>This means you need a catch block around your code. In my own code I&#8217;ve written a http_parameters_quietly that wraps the exception and fails.</p></div>
<div class="paragraph"><p>Gotcha #2: POST requests where the body has query string syntax aren&#8217;t available without the form_data option.</p></div>
</div>
<div class="sect2">
<h3 id="_handling_post_requests">7.2. Handling POST requests</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Parameter example</div>
<div class="paragraph"><p>This section uses file post_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>POST is often used to send large chunks of data not in search string format. Example post_example demonstrates directly reading the data POSTed by a web form.</p></div>
<div class="paragraph"><p>Contrary to the statement at the top of the SWI-Prolog page, POST requests are not transparently handled. If you&#8217;re handling a POST request you&#8217;ll need to add the <code>form_data</code> option to the <code>http_parameters/3</code> form. Additionally, the code apparently reads the POST data once, and can&#8217;t backtrack.</p></div>
</div>
<div class="sect2">
<h3 id="_advanced_parameter_tricks">7.3. Advanced Parameter Tricks</h3>
<div class="paragraph"><p>A semi-useful tool for websites that shove many of the same parameters around is the <code>attribute_declarations</code> option of +http_parameters/3. This allows you to define how to validate various parameters in one place.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>reply(Request) :-
        http_parameters(Request,
                        [ title(Title),
                          name(Name),
                          age(Age)
                        ],
                        [ attribute_declarations(param)
                        ]),
        ...

param(title, [optional(true)]).
param(name,  [length &gt;= 2 ]).
param(age,   [integer]).</code></pre>
</div></div>
<div class="paragraph"><p>Another useful gem is <code>http:request_expansion</code>. This lets you <em>decorate</em> the request. For example, if you want some common data from a database attached to most requests, you could just have <code>request_expansion</code> decorate it.</p></div>
<div class="paragraph"><p>Skipping ahead a bit, the session data is in the request structure and covers most uses of request_expansion.</p></div>
<div class="paragraph"><p>Finally, you&#8217;ll soon tire of passing Request around. You can get the current Request object with <code>http_current_request.</code></p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise:
Create a landing page for the web form you made in <em>inclusion and modules</em>.</p></div>
<div class="paragraph"><p>Exercise:
Change that web form from GET to POST</p></div>
<div class="paragraph"><p>Exercise:
Use curl to send some arbitrary data via POST body to a handler.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_file_upload">7.4. File Upload</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">File Upload example</div>
<div class="paragraph"><p>This section uses file file_upload_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This example is taken in it&#8217;s entirety from <a href="http://www.swi-prolog.org/howto/http/FileUpload.html">The SWI-Prolog docs for uploading files</a></p></div>
<div class="paragraph"><p>The documentation&#8217;s pretty clear.</p></div>
<div class="paragraph"><p>Since this is all Jan&#8217;s code, not mine, you&#8217;ll need to query run. and then browse localhost:8080</p></div>
<div class="paragraph"><p>Multipart MIME uploads involve all sorts of insanity.  I refer you to</p></div>
<div class="paragraph"><p><a href="https://groups.google.com/forum/#!searchin/swi-prolog/file$20upload/swi-prolog/ABzhD4EKKAY/xj_nxVsKqxUJ">The mail list discussion</a> for the gory details.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessions">8. Sessions</h2>
<div class="sectionbody">
<div class="paragraph"><p>An explanation, if you don&#8217;t know what sessions are.</p></div>
<div class="paragraph"><p>The basic design of the web is stateless. Every transaction is independent of every other transaction. But we want to have an ongoign conversation with the user - when they put something in their shopping cart, we want to remember it.</p></div>
<div class="paragraph"><p>Enter sessions. We give the browser a unique number (usually as a <em>cookie</em>) that they give back to us. We then look up the data associated with that session number, and we have the user&#8217;s data. Of course eventually memory would fill with sessions, so we delete old sessions. If we don&#8217;t have the data for a session ID, we just start a new one. You can see this by going to a site, putting something in a shopping cart, then not coming back to the site for months.</p></div>
<div class="paragraph"><p>Now, on to handling sessions in SWI-Prolog.</p></div>
<div class="sect2">
<h3 id="_basic_session_usage">8.1. Basic Session Usage</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Session example</div>
<div class="paragraph"><p>This section uses file session_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>At this point you&#8217;re probably fantasizing about all the stuff you can make in SWI-Prolog web, but you know you&#8217;re going to have to track sessions.</p></div>
<div class="paragraph"><p>Sessions are ubiquitous on the web. I assume some of you understand sessions, but for those who don&#8217;t -</p></div>
<div class="paragraph"><p>When a user visits a web page, they&#8217;re handed a cookie, a code they&#8217;re supposed to hand back to the server with the next page request. So you visit the fluffy bunnies site, and you&#8217;re given 3472723</p></div>
<div class="paragraph"><p>You ask for another page, and your browser sends along cookie 3472723. The server knows you&#8217;re user 3472723 and can customize the page for you.</p></div>
<div class="paragraph"><p>The classic example of this is shopping carts. You click a link to put a beany baby in your shopping cart, and the server now has a data structure <em>3472723 has a beany baby in their shopping cart</em>, and when it generates the page it puts <em>1</em> over the shopping cart icon.</p></div>
<div class="paragraph"><p>Eventually, of course, the server gets rid of the session. Usually after 30 minutes or so without hearing from the user.</p></div>
<div class="paragraph"><p>The example provided with the tutorial gives the user a silly name. Once the name&#8217;s established, it will be used on
subsequent visits as long as the session lasts. Most systems keep sessions about 30 minutes after the last activity
(its settable in swi-prolog).</p></div>
<div class="paragraph"><p>Whats going on <em>under the covers</em> is that the first httpRequest includes in its' response a set-cookie header with a
random number. Subsequent requests pass this cookie back to the server, so the user gets a persistent identity.
Now data can be associated with that identity using http_session_asserta and http_session_data</p></div>
<div class="paragraph"><p>Implementing session control is insanely simple. More fun than <a href="http://xkcd.com/353/">Python</a></p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(http/http_session)).</code></pre>
</div></div>
<div class="paragraph"><p>Wait, no, cmon, it can&#8217;t be that simple!</p></div>
<div class="paragraph"><p>Yup. It is. You got sessions.</p></div>
<div class="paragraph"><p>You know that lovable school/military/fascist youth camp tradition of giving people horrible nicknames? Ones they could never change? You didn&#8217;t find it lovable? Me neither.</p></div>
<div class="paragraph"><p>Lets build a site that gives people more affirming nicknames. Of course, once we pick their nickname, they&#8217;re stuck with it as long as their session lasts. Right, Oh Blessed One?</p></div>
<div class="paragraph"><p>Each request has a current session. That session has it&#8217;s own knowledge base that can be controlled with <code>http_session_assert</code>, <code>http_session_retractall</code>, and the obvious analogous calls, and queried with <code>http_session_data/1</code>.  It&#8217;s elegant and easy.</p></div>
<div class="paragraph"><p>So, for our example, we&#8217;ll check to see if we&#8217;ve given this person a nick. If we find one in their session data, great.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>nick_name(Nick) :-
    http_session_data(nick_name(Nick)),!.</code></pre>
</div></div>
<div class="paragraph"><p>If not, we&#8217;ll make one and assert into the session data</p></div>
<div class="listingblock">
<div class="content">
<pre><code>nick_name(Nick) :-
    nick_list(NickList),
    random_member(Nick, NickList),
    http_session_assert(nick_name(Nick)).

nick_list([
    'Gentle One',
    'Blessed Spirit',
    'Wise Soul',
    'Wise One',
    'Beloved Friend'
      ]).</code></pre>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Run the server. Reload the page several times.</p></div>
<div class="paragraph"><p>Completely exit SWI-Prolog and rerun the server. Confirm you can get a different name this way.</p></div>
<div class="paragraph"><p>Exercise: Add another handler that lets you reset your nick without restarting the server. Use http_session_retractall to get rid of the old nick. Hint - you can just recurse into the handler to get the new one.</p></div>
</div></div>
<div class="paragraph"><p>We won&#8217;t cover it in this course, but you can control who gets a session. If you set the <code>http_set_session_options</code> create option to noauto you can  manually create sessions. If you want you can set the session lifetime. This can dramatically affect server memory if have a typical distribution of visitors, with many arriving at a single page and a few staying.</p></div>
<div class="paragraph"><p>You can also restrict which parts of your site cause a session to be created. This can be very useful for, say, an informational site that doesn&#8217;t need sessions for most visitors, but includes a small online store selling cafe press mugs and so on and needs sessions for the shopping cart.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise:
Change the timeout for how long sessions last</p></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handler_id_8217_s">9. Handler ID&#8217;s</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Handler ID example</div>
<div class="paragraph"><p>This section uses file handler_id_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The other half of abstract paths is ways to refer to handlers that don&#8217;t break even if we move their location around. Handler ID&#8217;s are that solution.</p></div>
<div class="paragraph"><p>I think of this joke when I think of handler id&#8217;s in SWI-Prolog.</p></div>
<div class="paragraph"><p><span class="image">
<img src="http://imgs.xkcd.com/comics/standards.png" alt="Fortunately" />
</span></p></div>
<div class="paragraph"><p>We can represent a handler in many different ways:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http://27.0.0.1:8080/f/bar
/f/bar
files(bar)
root('f/bar')
the f_bar_handler predicate</code></pre>
</div></div>
<div class="paragraph"><p>But ultimately none of these names <strong>this</strong> handler. All but the first name a <strong>path</strong>, concretely or abstractly. And that&#8217;s something that can move around.</p></div>
<div class="paragraph"><p>The last names the handling predicate. Often that&#8217;s unique to a handler, but not always, as we&#8217;ve seen. So you can provide an option <code>id(login_page)</code> to the http_handler option list to name the handler itself. Once it has a name you can refer to it in various places, the most useful of which is for making links that don&#8217;t break when you move things around:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>a(href=location_by_id(login_page), 'Log in')</code></pre>
</div></div>
<div class="paragraph"><p>Now, that&#8217;s great if whoever wrote the login_page handler gave it an ID. But if not, can you do the next best thing, and refer to the rule that handles it? Yup.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>a(href=location_by_id(login_page_handler), 'Log in')</code></pre>
</div></div>
<div class="paragraph"><p>Of course it&#8217;s probably in some other module. We can handle that (it&#8217;s not obvious we can, we&#8217;re in termerized HTML, not Prolog, remember)</p></div>
<div class="listingblock">
<div class="content">
<pre><code>a(href=location_by_id(login_module:login_page_handler), 'Log in')</code></pre>
</div></div>
<div class="paragraph"><p>If it&#8217;s got args, you&#8217;ll need to omit those (so it&#8217;s less useful for our exercise)</p></div>
<div class="paragraph"><p>And, a couple tools that occasionally are handy:</p></div>
<div class="paragraph"><p>Get a URI for an ID</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http_location_by_id(+ID, -Location)</code></pre>
</div></div>
<div class="paragraph"><p>And</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http_link_to_id(+HandleID, +Parameters, -HREF)</code></pre>
</div></div>
<div class="paragraph"><p>And now for an exercise:</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Modify new_abstract_path.p and use the two API&#8217;s above from the top level to establish the locations of some of the handlers.</p></div>
<div class="paragraph"><p>Now add some ID&#8217;s to its' handlers. Using reply_html_page and html//1, make a site map that links to the other pages. Make the href&#8217;s by location.</p></div>
<div class="paragraph"><p>Now move its other pages to different URI&#8217;s without changing your new handler code.</p></div>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_special_handlers">10. Special Handlers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_serving_files">10.1. Serving Files</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Static Files example</div>
<div class="paragraph"><p>This section uses file static_files_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><span class="image">
<img src="assets/swipl.png" alt="assets/swipl.png" />
</span></p></div>
<div class="paragraph"><p>I hope by this point you&#8217;re getting excited about SWI-Prolog web!.</p></div>
<div class="paragraph"><p>Maybe you&#8217;re so excited you want to serve up the SWI-Prolog owl!</p></div>
<div class="paragraph"><p>No?</p></div>
<div class="paragraph"><p>Well, you probably do have assets like this you want to serve up.</p></div>
<div class="paragraph"><p>Fortunately, there&#8217;s a canned handler that will serve files in a directory tree.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler(files(.), http_reply_from_files('assets', []), [prefix]).</code></pre>
</div></div>
<div class="paragraph"><p>This line deserves some scrutiny.</p></div>
<div class="paragraph"><p>First, note that we&#8217;re finally seeing why I&#8217;ve been dragging around this files(.) location. Our path is the root of <em>files</em>, which maps to uri /f</p></div>
<div class="paragraph"><p>Second, we&#8217;re using a path alias to describe the file&#8217;s location. In this case we&#8217;re just using assets, which is a subdirectory of the current one.</p></div>
<div class="paragraph"><p>Lastly, note the <code>prefix</code>. So everything under the assets directory will be served. Wow, just like we&#8217;re Apache or something! Maybe not. Can&#8217;t make a living maintaining SWI-Prolog config files.</p></div>
<div class="paragraph"><p>Run the server and browse <a href="http://127.0.0.1:8080/f/swipl.png">http://127.0.0.1:8080/f/swipl.png</a></p></div>
<div class="paragraph"><p>Congrats! The owl appears.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content"><code>serve_files_from_directory/2</code> is an older, less capable version. New code should use <code>http_reply_from_files/2</code>.</td>
</tr></table>
</div>
<div class="paragraph"><p>One bit of security here. You don&#8217;t want to serve something outside the served space, so need to prevent J Random Hacker from asking for <code>http://mysite.com/f/../../../etc/passwd</code> or some such. So, it&#8217;s wise to use <code>http_safe_file/2</code> to sanitize file names. http_reply_file does the sanitizing for you.</p></div>
<div class="paragraph"><p>With finding files in various places and whatnot, interestingly, the SWI-Prolog website&#8217;s code to serve static assets is a good page long, much of it involved in displaying txt files by converting to html.</p></div>
<div class="paragraph"><p>Hey, what happens if you ask for the directory? There&#8217;s a kumquat in there!</p></div>
<div class="paragraph"><p>Gives a directory listing just like a real web server, even if it <strong>is</strong> in a language that&#8217;s only used for AI (wink wink).</p></div>
<div class="paragraph"><p>And, for the record, you can make an index.html page just like normal. Browse <a href="http://127.0.0.1:8080/f/">http://127.0.0.1:8080/f/</a></p></div>
<div class="paragraph"><p>The SWI-Prolog libraries define a few static file handlers - <code>css, js, and icon</code> are all defined already. You probably want to have those same handlers. Easy! Just add your directory to the file alias the library handler is already handling. If your css files are in <code>./files/css</code> under your project directory, you can just do:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user:file_search_path(css, 'files/css').</code></pre>
</div></div>
<div class="paragraph"><p>Don&#8217;t do this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user:file_search_path(css, root('files/css')).</code></pre>
</div></div>
<div class="paragraph"><p>because root&#8217;s a URI path alias, not a file alias</p></div>
<div class="paragraph"><p>So, what happens if we ask for something that&#8217;s not there?  Try <a href="http://127.0.0.1:8080/f/robot.png">http://127.0.0.1:8080/f/robot.png</a></p></div>
<div class="paragraph"><p>Hmm&#8230; that&#8217;s not so good. Nasty error message.</p></div>
<div class="paragraph"><p>Hey, speaking of error messages, that default error page isn&#8217;t going to fly in production.</p></div>
</div>
<div class="sect2">
<h3 id="_custom_error_pages">10.2. Custom Error Pages</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Custom Error Page example</div>
<div class="paragraph"><p>This section uses file custom_status_page.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>When we ask for a nonexistant page, or when the handler fails or throws an exception, the framework displays a default status page.</p></div>
<div class="paragraph"><p>We can customize the status page by defining a hook predicate.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        :- use_module(library(http/http_header)).

        :- multifile http:status_page/3.

        http:status_page(not_found(URL), _Context, HTML) :-
                phrase(page([ title('Sorry, no such page')
                                ],
                                {|html(URL)||
        &lt;h1&gt;Sorry, no such page&lt;/h1&gt;
        &lt;p&gt;I'm afraid you asked for a page we do not have.  Please try the
        search box to locate the page you are looking for.
                                |}),
                           HTML).</code></pre>
</div></div>
<div class="paragraph"><p>The first argument to <code>http:status_page/3</code> will be one of these statuses, which map to the text version of the various HTTP statuses.</p></div>
<div class="paragraph"><p>For example, to override 500 status errors, unify the first term with <code>server_error(_)</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        %          - authorise(Method)
        %            Challenge authorization.  Method is one of
        %            - basic(Realm)
        %            - digest(Digest)
        %          - authorise(basic,Realm)
        %            Same as authorise(basic(Realm)).  Deprecated.
        %          - bad_request(ErrorTerm)
        %          - `busy`
        %          - created(Location)
        %          - forbidden(Url)
        %          - moved(To)
        %          - moved_temporary(To)
        %          - `no_content`
        %          - not_acceptable(WhyHtml)
        %          - not_found(Path)
        %          - method_not_allowed(Method, Path)
        %          - `not_modified`
        %          - resource_error(ErrorTerm)
        %          - see_other(To)
        %          - switching_protocols(Goal,Options)
        %          - server_error(ErrorTerm)
        %          - unavailable(WhyHtml)</code></pre>
</div></div>
<div class="paragraph"><p>So now we have nice professional looking error pages.</p></div>
<div class="paragraph"><p>Now, what if you need to generate the page?  For example, if you discover that someone is trying a forbidden operation deep in the code, you can</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    throw(http_reply(Term))</code></pre>
</div></div>
<div class="paragraph"><p>Where Term is one of the above.</p></div>
<div class="paragraph"><p>Alternatively, you can generate one of these pages yourself, using <code>http_status_reply/4</code> to generate the page. Notice that you need to do this at the handler level.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: How would you make a <em>site offline</em> function that the NOC staff could control?</p></div>
<div class="paragraph"><p>Exercise: Modify static_files_example.pl to serve javascript, css, and image files from 3 separate directories.</p></div>
<div class="paragraph"><p>Exercise: extend the custom_status_page.pl file to have a second link to a page that exists, but does a divide by zero in it&#8217;s handler.
Give your server a nice 500 error page.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_redirect">10.3. Redirect</h3>
<div class="paragraph"><p>You&#8217;re probably wondering what happened to redirects. If you&#8217;re used to the old <em>not signedin, redirect</em> paradigm, you need it. But, actually, instead of a redirect, consider calling the handler of the page you&#8217;re redirecting to.</p></div>
<div class="paragraph"><p>If you need a real redirect, use <a href="http://www.swi-prolog.org/pldoc/doc_for?object=http_redirect/3"><code>http_redirect/3</code></a></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_including_resources">11. Including Resources</h2>
<div class="sectionbody">
<div class="paragraph"><p>Well, we can serve files, now lets get them included in our web pages.</p></div>
<div class="sect2">
<h3 id="_using_mailman_to_include_css">11.1. Using mailman to include CSS</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">Don&#8217;t actually do this in real code. See next section.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Resource by Mailman example</div>
<div class="paragraph"><p>This section uses file resource_by_mailman.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>One way to include resources is to use mailman to mail them into the head.</p></div>
<div class="paragraph"><p>We&#8217;ll receive the stylesheet link in the head. No need for fancy, we&#8217;ll just put it in the material included in the head by <code>reply_html_page</code></p></div>
<div class="listingblock">
<div class="content">
<pre><code>a_handler(_Request) :-
    reply_html_page(
        [title('a page with style'),
         \html_receive(css)],
        [h1('A Page That Glitters'),
         \css('/f/specialstyle.css'),
         p('This para is green')]).</code></pre>
</div></div>
<div class="paragraph"><p>Now we need to make sure the css link gets sent. How about making an inclusion that does this for an arbitrary URL. Then we can include whatever bit of special CSS without much code.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>css(URL) --&gt;
        html_post(css,
                  link([ type('text/css'),
                         rel('stylesheet'),
                         href(URL)
                       ])).</code></pre>
</div></div>
<div class="paragraph"><p>There is an implied html_receive(head) in reply_html_page. This is very useful for sending random things to the head.</p></div>
<div class="paragraph"><p>A common situation is dealing with ugly hacks to get around IE borkedness. Here&#8217;s a mess I needed for a Leaflet map:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&lt;!--[if lte IE 8]&gt;
&lt;link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css"&gt;
&lt;![endif]--&gt;</code></pre>
</div></div>
<div class="paragraph"><p>The way to handle this is to use <code>\[&#8230;]</code> and mailman</p></div>
<div class="listingblock">
<div class="content">
<pre><code> :-html_meta if_ie(+,html,?,?).
 if_ie(Cond, HTML) --&gt;
    html(\['&lt;!--[if ', Cond, ']&gt;' ]),
    html(HTML),
    html(\['&lt;![endif]--&gt;' ]).

    ... then when I want to insert conditional material ...
     html([
          \html_requires(leaflet),
          \html_post(head,
            \if_ie('lte IE 8',
                      link([ rel(stylesheet),
                        href('http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css')
                      ]))),
              div([ id(ID)
             ],
             [])]),</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_including_resources_with_code_html_resource_code">11.2. Including Resources With <code>html_resource</code></h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Proper Resource Example</div>
<div class="paragraph"><p>This section uses file resource_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This material is described in the <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%283,%273.20%27,swi%28%27/doc/packages/http.html%27%29%29">SWI-Prolog doc for resources</a></p></div>
<div class="paragraph"><p>Looking at the previous method of including resources, a few defects of the method come to mind</p></div>
<div class="ulist"><ul>
<li>
<p>
There is nothing preventing the resource from being included twice
</p>
</li>
<li>
<p>
It&#8217;s a bit of unneeded ceremony
</p>
</li>
<li>
<p>
If a resource needs another resource you have to remember that yourself
</p>
</li>
</ul></div>
<div class="paragraph"><p>SWI-Prolog to the rescue. Using the resource manager, you describe <em>resources</em>, and then include them with <code>html_requires//1</code>.</p></div>
<div class="paragraph"><p>How you include a resource of course depends on it&#8217;s type, because it has to know how to write the tag to include it (eg for css it&#8217;s to make a stylesheet link). So the default only understands javascript and css, but you can add your own types.</p></div>
<div class="paragraph"><p>So, our page requires some special bit of css in specialstyle.css, which depends on the corporate standard <em>gradstyle.css</em>. So lets enforce including gradstyle.css any time we include specialstyle.css.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- html_resource(files('specialstyle.css'), [requires(files('gradstyle.css'))]).</code></pre>
</div></div>
<div class="paragraph"><p>The first arg is a standard path, as an URI or abstract path. The second is a <code>properties</code> list. The most useful is requires, which takes another resource path, one of a resource name, an abstract path or an URI. If there is more than one required resource, pass them as a list. Use the <code>ordered(true)</code> option to enforce their being loaded in the list order.</p></div>
<div class="paragraph"><p>There are a few other very useful options.</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>virtual(true)</code> lets you set up, for example, bootstrap as a single resource, bootstrap, and get the js, the css, and anything else it needs, or decouple bootstrap from a version number
</p>
</li>
<li>
<p>
<code>ordered(true)</code> makes sure the resources get loaded in the right order.
</p>
</li>
<li>
<p>
<code>aggregate/1</code> is supposed to be for situations where you might need only a small part of a large file. If you have a big css file with sections A, B, C, and D, and four smaller files A,B,C, and D, and you load the big one in one place, you don&#8217;t need the smaller ones. The <em>a number of</em> algorithm is pretty dumb. It&#8217;s <em>greater than 4</em>.
</p>
</li>
<li>
<p>
<code>mime_type/1</code> lets you specify the type of a resource, so if your javascript file is named bunny.poo for some strange reason, you can still load it as javascript. I believe the documentation is wrong, it&#8217;s + mode.
</p>
</li>
</ul></div>
<div class="paragraph"><p>On larger projects I usuallay set up a virtual resource for each item, that in turn requires the real file. This way, if I change versions of jQuery I only have to change it in one place.</p></div>
<div class="paragraph"><p>The other bit of magic we need is to declare that we need the resource. Since the declaration&#8217;s a DCG we can just stick it in the termerized HTML.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>a_handler(_Request) :-
    reply_html_page(
        [title('a page with style')],
        [h1('A Page That Glitters'),
         \html_requires(files('specialstyle.css')),
         p('This para is green')]).</code></pre>
</div></div>
<div class="paragraph"><p><code>reply_html_page</code> handles everything under the covers.</p></div>
<div class="paragraph"><p>A useful tool for debugging resource dependencies is to turn on debug(html(script))</p></div>
<div class="paragraph"><p>and monitor in the debug message window.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise:
Use highcharts (<a href="http://www.highcharts.com/">http://www.highcharts.com/</a>) to put a chart on a web page. Include all needed material with resources.</p></div>
</div></div>
<div class="sect3">
<h4 id="_adding_mime_type_handlers">11.2.1. Adding mime type handlers</h4>
<div class="paragraph"><p>File extensions are a (not very good, but universal) way to indicate content type. To get the actual mime type we can use <code>file_mime_type/2</code></p></div>
<div class="listingblock">
<div class="content">
<pre><code>2 ?- file_mime_type('foo.js', X).
Correct to: "mimetype:file_mime_type('foo.js',X)"? yes
X = text/javascript.

3 ?- file_mime_type('foo.txt', X).
Correct to: "mimetype:file_mime_type('foo.txt',X)"? yes
X = text/plain.

4 ?- file_mime_type('foo.xlsx', X).
Correct to: "mimetype:file_mime_type('foo.xlsx',X)"? yes
X = application/unknown.</code></pre>
</div></div>
<div class="paragraph"><p>Hmm&#8230; seems SWI-Prolog isn&#8217;t willing to admit that xlsx is an Excel spreadsheet.</p></div>
<div class="paragraph"><p>If you need it to work, you can override mime:mime_extension/2</p></div>
<div class="paragraph"><p>Now you have two ways of getting the mime type of a file - through file_mime_type or through the resource definition mime_type option. With the mime type, can we add other types of resources?</p></div>
<div class="paragraph"><p>Sure! You&#8217;re in SWI-Prolog. Add a clause to the hook DCG <code>mime_include//2</code> and generate some tokenized HTML. Here&#8217;s a way to import a prolog script (useful with pengines)</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- multifile
    html_head:mime_include//2.

html_head:mime_include(text/'x-prolog', Path) --&gt; !,
    html(script([ type('text/x-prolog'),
                  src(Path)
                ],  [])).</code></pre>
</div></div>
<div class="paragraph"><p>There are a number of web resources you might need - perhaps your page needs some XML definition, or XSL fonts with the @import mechanism, or maybe some compile after load script language. Whatever you need to send, you can do it with the resource manager.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise (harder): Use mime_include//2, and file_mime_type/2
Coffeescript is a preprocessor that takes in .coffee files and emits javascript.
Assume your make system generates an associated .js file with a parallel name in the same directory.</p></div>
<div class="paragraph"><p>Create a module that lets you require a coffeescript file. After loading your code, a programmer should only need to <code>\html_requires(js('somescript.coffee'))</code> to invoke the coffeescript compiler and load the resulting js file into an appropriate meta tag.</p></div>
<div class="paragraph"><p>Extra credit: eliminate the blind dependence on the external build. Check for the absence of the js file or an older timestamp, and invoke the compiler as needed.</p></div>
<div class="paragraph"><p>Double extra credit: Make these for all the preprocessor languages, make them robust (eg use a setting to find the preprocessor&#8217;s command line), and bundle them as a pack. If no one has done so first, publish your pack on swi-prolog.</p></div>
</div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_javascript_and_json">12. Javascript and JSON</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_including_dynamic_javascript">12.1. Including Dynamic Javascript</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Javascript Example</div>
<div class="paragraph"><p>This section uses file javascript_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>There is an older predicate based system for creating dynamic Javascript. It&#8217;s deprecated in favor of quasiquotes.</p></div>
<div class="paragraph"><p>Quasiquotes let you insert another language into the midst of Prolog code. Handling Javascript is an obvious application.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>?3 ?- use_module(library(http/js_write)).
true.

4 ?- Y=7, X = {|javascript(Y)||$(function(Y){ console.log(Y); }); |}.
Y = 7,
X = \['$(function(', \js_expression(7), '){ console.log(', \js_expression(7), '); }); '].</code></pre>
</div></div>
<div class="paragraph"><p>You probably want that surrounded with a <code>&lt;script&gt;</code> tag.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>\js_script({|javascript(X)|| console.log(X); |})</code></pre>
</div></div>
<div class="paragraph"><p>The javascript parsing doesn&#8217;t allow placing variables in all the places you might like. If it&#8217;s fighting you you&#8217;ll have to use <code>\[ ]</code> and give up syntax checking.</p></div>
</div>
<div class="sect2">
<h3 id="_json">12.2. JSON</h3>
<div class="paragraph"><p>There are two sets of JSON handling tools. The older set predates dicts in SWI-Prolog and is deprecated, but you may encounter it.</p></div>
<div class="paragraph"><p>The older set reads and writes serialized JSON to objects of the form <code>json( &#8230; list of key=value pairs&#8230; )</code> using <code>json_read/3</code> and <code>json_write/3</code>. The http client library contains a <a href="http://www.swi-prolog.org/pldoc/man?section=httpjson">plugin</a> for reading JSON from http.</p></div>
<div class="paragraph"><p>Since this isn&#8217;t a very natural representation for Prolog, theres' a <a href="http://www.swi-prolog.org/pldoc/man?section=jsonconvert">library to convert between the json(list) format and Prolog terms</a>.</p></div>
<div class="paragraph"><p>With dicts, all this improves greatly. There are new <code>json_read_dict/2</code> , <code>json_read_dict/3</code> ,  <code>json_write_dict/2</code> , <code>json_write_dict/3</code> ,  which use dicts. So a REST handler can be as short as 5 lines.</p></div>
<div class="paragraph"><p>Here&#8217;s a simple REST handler.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler(/api, handle_api, []).

handle_api(Request) :-
        http_read_json_dict(Request, Query),
        solve(Query, Solution),
        reply_json_dict(Solution).</code></pre>
</div></div>
<div class="paragraph"><p>There&#8217;s one complication here. By default, the <code>http_read_json_dict/2</code> is pretty strict about mime type, only accepting <code>application/json</code> .</p></div>
<div class="paragraph"><p>The problem is that actual browsers send various types. You can expand the list of types accepted with  the multifile <code>json_type/1</code> .</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(http/http_json)).

:- multifile http_json/1.

http_json:json_type('application/x-javascript').
http_json:json_type('text/javascript').
http_json:json_type('text/x-javascript').
http_json:json_type('text/x-json').</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_communicating_with_the_server">13. Communicating With The Server</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ajax">13.1. AJAX</h3>
<div class="paragraph"><p>As we&#8217;ve just seen, we can accept and return JSON, so we can implement AJAX, but there are other ways to communicate with the server.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise:
Build a small web page based on <a href="http://www.highcharts.com/stock/demo/basic-line">Highstock&#8217;s line chart demo</a> that displays a real time graph of
the number of bytes used in the heap, using <a href="http://www.swi-prolog.org/pldoc/man?predicate=statistics/2">statistics/2</a> and AJAX.</p></div>
<div class="paragraph"><p>Note - yes, this exercise involves repeats of previous material. It&#8217;s skill building.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_pengines">13.2. Pengines</h3>
<div class="paragraph"><p>Pengines is a rather nifty distributed computing system by Torbjorn Lager that ships with SWI-Prolog.</p></div>
<div class="paragraph"><p>Its so nifty I&#8217;m going to do a <em>real world</em> tutorial just on Pengines, so I&#8217;ll just mention it here.</p></div>
<div class="paragraph"><p>Pengines allows the client to run queries in a sandboxed environment on the server. This gives the client the full expressive power of Prolog as a query language.</p></div>
<div class="paragraph"><p>It&#8217;s also a heck of a lot easier than any other way of making AJAX like behavior.</p></div>
<div class="paragraph"><p>For now, you can check out my talk about pengines at <a href="https://www.youtube.com/watch?v=JmOHV5IlPyU">Strange Loop 2014</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_websockets">13.3. WebSockets</h3>
<div class="paragraph"><p>SWI-Prolog has built-in support for WebSockets. If you want to do a collaborative application check out <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%282,%275%27,swi%28%27/doc/packages/http.html%27%29%29">WebSocket Support</a></p></div>
<div class="paragraph"><p>There is, kicking around, a file, hub.pl, that supports chat room type behavior. Material sent by one participant is shared by all.</p></div>
</div>
<div class="sect2">
<h3 id="_cors">13.4. CORS</h3>
<div class="paragraph"><p><a href="http://www.w3.org/TR/cors/">Cross-Origin Resource Sharing</a> is the useful technique of serving AJAX-y data from a different server than the page itself. It&#8217;s also well documented as a <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">security risk</a>.</p></div>
<div class="paragraph"><p>You can turn CORS on for a specific handler just by including <code>cors_enable/0</code> in the handler, and setting the domain list to which we&#8217;ll serve foreign resources in the setting <code>http:cors</code> . For more info, check out <a href="http://www.swi-prolog.org/pldoc/man?section=httpcors">The CORS library docs</a> .</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication">14. Authentication</h2>
<div class="sectionbody">
<div class="paragraph"><p>Need to control access to your web application?</p></div>
<div class="sect2">
<h3 id="_http_request_expansion">14.1. http_request_expansion</h3>
<div class="paragraph"><p>The <em>usual</em> way to authenticate these days is an HTML login form. This requires examining subsequent requests for a JWT or session ID.</p></div>
<div class="paragraph"><p>This can conveniently be done by using <code>http_request_expansion</code>. This is called as a directive to install the hook.</p></div>
<div class="paragraph"><p>For example, my <a href="https://github.com/Anniepoo/identity">identity pack</a> uses three such expansions - one to establish that the user is indeed logged in, one which extends the cookie if the user has marked the <strong>remember me</strong> checkbox, and one that establishes that the user has the proper role to view this resource (eg Bob can look only at Bob&#8217;s shopping cart, only HR accounts can look at HR data, etc). The whole thing is too long for here, but here&#8217;s a sample:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>% order is important, need user field in second and third
:- http_request_expansion(user_expand, 100).
:- http_request_expansion(remember_me_expand, 150).
:- http_request_expansion(role_based_authorization_expand, 200).

%!  user_expand(+Request0, -Request, +Options) is semidet.
%
%   HTTP request rewriter that figures out whether someone is logged in.
%   using this technique we can use   different  techniques to establish
%   the logged in status.
%
%   If the user is logged in, we add user(User) to the request
%
user_expand(Request0, Request, _Options) :-
    http_in_session(_),
    http_session_data(user(User)),
    Request = [user(User)|Request0].</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_basic_digest_authentication">14.2. Basic/Digest Authentication</h3>
<div class="paragraph"><p>An older, simpler scheme is basic or digest authentication, a part of the HTTP protocol. The newest way is through OpenID. We&#8217;ll look at basic and digest authentication first.</p></div>
<div class="paragraph"><p>Basic and digest authentication work more or less the same. The difference is that digest authentication doesn&#8217;t transmit the password in the clear.</p></div>
<div class="paragraph"><p>Both look for an authentication header in the request. If it&#8217;s not there, they respond with a 401 Unauthorized status, which makes the browser pop up the authentication dialog box like this</p></div>
<div class="paragraph"><p>image:authentication.png</p></div>
<div class="paragraph"><p>The browser then sends the request again, with the authentication header.</p></div>
<div class="paragraph"><p>The authentication header looks like (for basic authentication)</p></div>
<div class="listingblock">
<div class="content">
<pre><code>WWW-Authenticate: Basic realm="harbinger_realm"</code></pre>
</div></div>
<div class="paragraph"><p>So what&#8217;s this realm thing?</p></div>
<div class="paragraph"><p>You might want to have different logins for different areas of the server - e.g. one for general users, one for administrators.</p></div>
<div class="paragraph"><p>You can specify two different <em>realms</em> to make the user have to log in to each one.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Pro-tip - The realm value appears on the dialog. If you choose a name like <code><em>Enter username and password for admin access</em></code> you can somewhat improve the not great wording of the dialog box.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>With the theory out of the way, lets look at how to implement each in SWI-Prolog.</p></div>
</div>
<div class="sect2">
<h3 id="_basic_authentication">14.3. Basic Authentication</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Basic Authentication example</div>
<div class="paragraph"><p>This section uses file basic_authenticate_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Basic authentication is easy to implement. The <a href="http://www.swi-prolog.org/pldoc/man?section=httpauthenticate">basic authentication library</a> takes a Unix style htpasswd file and lets you authenticate users against it.</p></div>
<div class="paragraph"><p>Our sample <code>basic_authenticate_example.pl</code> looks for a valid authentication based on a file called passwd. It also has a couple predicates to create a new passwd file and add names to it.</p></div>
<div class="paragraph"><p>To use, query  <code>start_pw_file.</code> , which makes the username <strong>adminuser</strong> with password <strong>adminpw</strong>. To add users, query add_uname_pw.  Start the server and it will accept the user (the example doesn&#8217;t gracefully handle a missing passwd file).</p></div>
<div class="paragraph"><p>Now that you have a password file, run the server by querying <code>server(9000)</code> and browsing <a href="http://localhost:9000/">http://localhost:9000/</a> .
<strong>Instead of answering the dialog, cancel it</strong>. You&#8217;ll see a SWI generated warning page. Here&#8217;s the code that does the work.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        (   http_authenticate(basic(passwd), Request, _Fields)
        -&gt;  true
        ;   throw(http_reply(authorise(basic, harbinger_realm)))
        ),</code></pre>
</div></div>
<div class="paragraph"><p>If the <code>authentication/1</code> term exists in <code>Request</code> and matches a line in the file <code>passwd</code>, we&#8217;re logged in and we continue on to serve the page.
If the <code>authentication/1</code> term is missing or invalid, we throw http_reply(authorise(basic, harbinger_realm)). SWI sends the 401 status and the browser brings up the dialog.
If the user cancels, http_dispatch responds with a not authorized page.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>After you correctly answer it becomes hard to fiddle with the example. You can run the server on another port to convince the browser it&#8217;s talking to a different server</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_an_easier_way">14.3.1. An Easier Way</h4>
<div class="paragraph"><p>This seems like more than we need to <em>say</em> as programmers. We really just need a password file and realm name. This being Prolog, of course the easier way is available.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler('/easier', say_easier, [authentication(basic(passwd, unguent_realm))]).</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_digest_authentication">14.4. Digest Authentication</h3>
<div class="paragraph"><p>The biggest problem with basic authentication is that the credentials the user enters are transmitted in the clear.</p></div>
<div class="paragraph"><p>The correction for this was digest authentication.</p></div>
<div class="paragraph"><p>You can get digest authentication by the same API as basic authentication.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- http_handler('/', say_hi, [authentication(digest(passwd, lemon))]).</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_openid">14.5. OpenID</h3>
<div class="paragraph"><p>There is OpenID support.  It&#8217;s complex enough it&#8217;s not going to be covered in this tutorial.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_9_running_the_server">15. 9 Running The Server</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_9_1_server_top_level">15.1. 9_1 Server Top Level</h3>
<div class="paragraph"><p>Til now we&#8217;ve given you this block of voodoo code:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>server(Port) :-
        http_server(http_dispatch, [port(Port)]).</code></pre>
</div></div>
<div class="paragraph"><p>Jan writes about <em>three ways</em> to run the server.</p></div>
<div class="paragraph"><p><code>inetd</code>, a unix daemon that handles the outer network interface, requires starting the prolog server separately for each invocation, and isn&#8217;t really an option for serious work.</p></div>
<div class="paragraph"><p>The XPCE based server receives XPCE events for incoming requests. It&#8217;s not multithreaded, and it&#8217;s only advantage is that debugging is slightly easier in a single threaded enviornment.</p></div>
<div class="paragraph"><p>For serious use, the multi-threaded <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%284,%273.11.2%27,swi%28%27/doc/packages/http.html%27%29%29"><code>http_server</code></a> is the only reasonable choice.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Using the link above for http_server, answer the following questions</p></div>
<div class="ulist"><ul>
<li>
<p>
A client will be feeding your server data via long poll. What option will you have to adjust in <code>http_server</code>?
</p>
</li>
<li>
<p>
Your site for aerospace engineers processes data sets on users behalf by some powerful but very cpu intensive computation that can take up to 800MB of stack (but <em>normal</em> sized trail and global memory) and run for hours. The average site user will run one of these a day. The output is a large raw video file that is then transcoded into a standard video format. The transcoding is shelled out, but can take a long time (minutes) to complete. Use http_spawn and http_server documentation to replace the ??? sections in the code below. (Note, there is no one right answer for this question.)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(thread_pool)).
:- thread_pool_create(compute, ???,
                      [ local(??????), global(??????), trail(??????),
                        backlog(?)
                      ]).

:- thread_pool_create(video, ???,
                      [ local(???), global(????), trail(????),
                        backlog(???)
                      ]).

server(Port) :-
        http_server(http_dispatch, [port(Port), ?????]).

:- http_handler('/solve',     solve,     [spawn(compute)]).
:- http_handler('/video', convert_video, [spawn(video)]).</code></pre>
</div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_9_2_serving_on_port_80">15.2. 9_2 Serving on port 80</h3>
<div class="paragraph"><p>The simplest way to get your server onto port 80 to serve to the world is to have Apache reverse proxy.  if your server is on port 8000, add this to site.conf</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ProxyPass        /myserver/ http://localhost:8000/myserver/
ProxyPassReverse /myserver/ http://localhost:8000/myserver/</code></pre>
</div></div>
<div class="paragraph"><p>Note that this means absolute URLs in HTML content should be relative.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Set 5_1 up to be served from port 80 in your local environment.</p></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_10_handling_the_back_end">16. 10 Handling The Back End</h2>
<div class="sectionbody">
<div class="paragraph"><p>Your web application will presumably need a persistent store on the back end. You have a number of options.</p></div>
<div class="sect2">
<h3 id="_sql">16.1. SQL</h3>
<div class="paragraph"><p>A great quote from the SWI-Prolog docs</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>The value of RDMS for Prolog is often over-estimated, as Prolog itself can manage substantial amounts of data. Nevertheless a Prolog/RDMS interface provides advantages if data is already provided in an RDMS, data must be shared with other applications, there are strong persistency requirements or there is too much data to fit in memory.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>Now, I think if we asked Jan, he&#8217;d say the last, <em>persistency requirements</em> and <em>too much data for memory</em> are better addressed with other solutions like <a href="http://cliopatria.swi-prolog.org/home">ClioPatria</a></p></div>
<div class="paragraph"><p>But, if you need an SQL database, SWI-Prolog has a reasonable <a href="http://www.swi-prolog.org/pldoc/package/odbc.html">ODBC Interface</a></p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Connect to whatever DB you have handy in your local environment and read out part of an existing table using SWI-Prolog.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_persistency">16.2. Persistency</h3>
<div class="paragraph"><p>The persistency lib is a very neat alternative to a database.</p></div>
<div class="paragraph"><p>As memory size has grown, the idea of simply keeping the database in memory has become feasible. The persistency library provides automatic backup to disk.</p></div>
<div class="paragraph"><p>Using the library is easy.  Using the +persistent/1 declaration you can set up a structure similar to a database record.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(persistency)).

:- persistent  my_table(id:integer, name:atom, department:oneof([marketing, production, accounting]).</code></pre>
</div></div>
<div class="paragraph"><p>This expands to four predicates</p></div>
<div class="listingblock">
<div class="content">
<pre><code>my_table(Id, Name, Department) :- ...
assert_my_table(Id, Name, Department) :- ...
retract_my_table(Id, Name, Department) :- ...
retractall_my_table(Id, Name, Department) :- ...</code></pre>
</div></div>
<div class="paragraph"><p>Of course you&#8217;ll want to attach a file so the library persists to disk. Attaching the database file is also simple. Just use <code>db_attach/2</code>.</p></div>
<div class="paragraph"><p>You&#8217;ll need to decide when to sync the database.</p></div>
<div class="paragraph"><p>Simply use the prolog persistency lib to snapshot your data. See <a href="http://www.swi-prolog.org/pldoc/doc/swi/library/persistency.pl"><code>persistent/1</code></a></p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: Implement a toy application using the persistency lib.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_rdf">16.3. RDF</h3>
<div class="paragraph"><p>There&#8217;s a SPARQL server, <a href="http://cliopatria.swi-prolog.org/home">ClioPatria</a>, written in SWI-Prolog. Even better, you can run your application in the same VM as part of ClioPatria, and have direct access to the rdf triples. This makes a very low impedence bump method of storing data.</p></div>
<div class="paragraph"><p>The author has worked on a commercial development project using ClioPatria. After an initial learning curve, it&#8217;s proved easy and productive to use.
ClioPatria is memory based, which is a limitation.</p></div>
<div class="paragraph"><p>If your database is bigger than ClioPatria can handle, an alternative is a SPARQL based DB like <a href="https://jena.apache.org/documentation/fuseki2/index.html">Fuseki</a>. Prolog has good facilities for <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%282,%279%27,swi%28%27/doc/packages/semweb.html%27%29%29">talking to SPARQL</a></p></div>
<div class="paragraph"><p>A <a href="https://en.wikipedia.org/wiki/Datalog">Datalog</a> based DB. <a href="http://www.datomic.com/">Datomic</a> looks promising. Datalog is a subset of Prolog, so talking to it from prolog seems natural.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debugging_and_development_support">17. Debugging and Development Support</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_debugging_multi_threaded_code">17.1. Debugging Multi Threaded Code</h3>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: run one of the examples.</p></div>
<div class="paragraph"><p>query prolog_ide(thread_monitor).</p></div>
</div></div>
<div class="paragraph"><p>Oooh, didn&#8217;t that feel good?</p></div>
<div class="paragraph"><p>when starting the server, setting the number of threads to 1 can make debugging simpler. However, you may find your life complicated if one http request is stopped in the debugger and the page never finishes loading because the browser is making another request.</p></div>
</div>
<div class="sect2">
<h3 id="_reducing_abstract_wtf_moments">17.2. Reducing Abstract WTF Moments</h3>
<div class="sect3">
<h4 id="_resources">17.2.1. Resources</h4>
<div class="paragraph"><p>Use ?- debug(html(script)). to see the requested and final set of resources needed</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: query ?- prolog_ide(debug_monitor).</p></div>
<div class="paragraph"><p>Ooh and awe, then go read debug/1 and debug/3 docs</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_better_error_messages">17.2.2. Better Error Messages</h4>
<div class="paragraph"><p>Loading <code>library(http/http_error.pl)</code>  causes uncaught exceptions in the server to generate a 500 error page with the error. (Remove this in production, it&#8217;s never a good idea to give the hacker info about your system.) Most of the examples load this.</p></div>
</div>
<div class="sect3">
<h4 id="_paths">17.2.3. Paths</h4>
<div class="paragraph"><p>Abstract path locations can be confusing. You can check where they really resolve with <code>http_absolute_uri</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>?- http_absolute_uri(some('awful/path'), -URI)</code></pre>
</div></div>
<div class="paragraph"><p>File paths aren&#8217;t much better</p></div>
<div class="paragraph"><p>You can debug them by temporarily turning on the prolog flag</p></div>
<div class="listingblock">
<div class="content">
<pre><code>?-set_prolog_flag(verbose_file_search, true).</code></pre>
</div></div>
<div class="paragraph"><p>Any call to <code>absolute_file_name</code> (under the covers of anything that uses abstract paths) generates debug output.</p></div>
<div class="paragraph"><p>If you just need to check one, use <code>file_search_path(<em>some/path</em>, Path)</code>. It&#8217;s nondet, it&#8217;ll give you all the possiblities.</p></div>
<div class="paragraph"><p>But the best trick is that a relative path passed to <code>edit/1</code> takes you to the handler it resolves to, which is nifty.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>?- edit('/wheres/this/go?kumquat=1').</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_where_the_heck_am_i">17.2.4. Where The Heck Am I?</h4>
<div class="paragraph"><p>Another handy thing to put in the top of a puzzling handler is <a href="http://www.swi-prolog.org/pldoc/doc_for?object=section%283,%273.13%27,swi%28%27/doc/packages/http.html%27%29%29"><code>http_current_host</code></a>, whose last arg binds to the URI the server thinks it&#8217;s serving.</p></div>
</div>
<div class="sect3">
<h4 id="_ouch_that_hurt_on_4000">17.2.5. Ouch, that hurt on 4000</h4>
<div class="paragraph"><p>Literate programming. Knuth says it&#8217;s good, can&#8217;t be bad, right? Hey, Java supports it.</p></div>
<div class="paragraph"><p>Gotta pick a high port number. Steeped in tradition. Worked for a Chinese guy once who hired a feng-shui consultant to pick the number. Wish I could get that gig.</p></div>
<div class="paragraph"><p>4000 is <strong>not</strong> your number. The PLDoc server runs there, and may be running in the background.</p></div>
<div class="paragraph"><p>By default it&#8217;s off and only responds to localhost. If you turn it on, change the default, and forget:</p></div>
<div class="paragraph"><p>Phun 4 Hak3r Do0fs! Browse <a href="http://www.iamcoolmysitesinprolog.in:4000/">http://www.iamcoolmysitesinprolog.in:4000/</a> and read their PLDocs. That should make it easier to get in.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%% backup_pw(-UserName:atom, -Password:atom) is nondet
%   Hard coded admin password in case all else fails
backup_pw('admin', 'abc123').</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_logging">17.3. Logging</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">Logging Example</div>
<div class="paragraph"><p>This section uses file logging_example.pl</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>SWI-Prolog includes a fairly bare bones logging package. Simply including</p></div>
<div class="listingblock">
<div class="content">
<pre><code>:- use_module(library(http/http_log)).</code></pre>
</div></div>
<div class="paragraph"><p>turns on logging. This</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http_log('incorrect answer ~d, proper answer is 42, [Answer]).</code></pre>
</div></div>
<div class="paragraph"><p>Works just like format, but writes to the log file</p></div>
<div class="paragraph"><p>Run the example and look wherever you unzipped the examples. Youll have a new file, httpd.log</p></div>
<div class="paragraph"><p>Open it, you&#8217;ll see</p></div>
<div class="listingblock">
<div class="content">
<pre><code>/*Tue Aug 28 13:27:20 2012*/ request(2, 1346185640.163, [peer(ip(127,0,0,1)),method(get),request_uri('/favicon.ico'),path('/favicon.ico'),http_version(1-1),host('127.0.0.1'),port(8000),user_agent('Mozilla/5.0 (Windows NT 6.1; WOW64; rv:14.0) Gecko/20100101 Firefox/14.0.1'),dnt('1'),connection('keep-alive')]).
completed(2, 0.0, 428, 404, error(404,'/favicon.ico')).</code></pre>
</div></div>
<div class="paragraph"><p>Shucky darn!</p></div>
<div class="paragraph"><p>Look at that error! No favicon.ico! The world will fall in!</p></div>
<div class="paragraph"><p>At this moment your boss walks in and insists that you change the name of the log file.</p></div>
<div class="paragraph"><p>Groan, don&#8217;t you hate this sorta thing? finding it always takes way longer than it should.</p></div>
<div class="paragraph"><p>Fortunately you remember it&#8217;s in the settings, but of course have no idea what the setting name is. So you query</p></div>
<div class="listingblock">
<div class="content">
<pre><code>?- list_settings.</code></pre>
</div></div>
<div class="paragraph"><p>Ah, it&#8217;s http:logfiles</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Exercise: change that puppy!</p></div>
</div></div>
<div class="sect3">
<h4 id="_stopping_the_server">17.3.1. Stopping The Server</h4>
<div class="listingblock">
<div class="content">
<pre><code>?- http_stop_server(8000, []).</code></pre>
</div></div>
<div class="paragraph"><p>The options are ignored.</p></div>
</div>
<div class="sect3">
<h4 id="_we_8217_re_a_big_offical_site_we_have_a_noc">17.3.2. We&#8217;re A Big Offical Site, We Have A NOC</h4>
<div class="paragraph"><p>Look cool, make yourself an admin page that shows <a href="http://www.swi-prolog.org/pldoc/doc/home/vnc/prolog/src/plweb/stats.pl">server stats</a></p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">18. Security</h2>
<div class="sectionbody">
<div class="paragraph"><p>Security Checklist</p></div>
<div class="ulist"><ul>
<li>
<p>
are you vulnerable to prolog injection attacks? (easy to do with metaprogramming)
</p>
</li>
<li>
<p>
shell injection attacks? (sanitize args passed to shell). Prefer <code>process_create/3</code> over <code>shell/1</code>.  Safe argument handling and you can handle the output from the process much easier.
</p>
</li>
<li>
<p>
SQL injection?
*PLDoc server on? (see Ouch that hurt on 4000)
</p>
</li>
<li>
<p>
Don&#8217;t include <code>library(http/http_errors.pl)</code> in production to make hacker&#8217;s jobs harder
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_enlightened_self_interest">19. Enlightened Self Interest</h2>
<div class="sectionbody">
<div class="paragraph"><p>The only way to really become competent with an API is to use it. So, just as much as exercises or this page, I encourage you to make a project with the SWI tools.</p></div>
<div class="paragraph"><p>I imagine many of you will have a project - it will be why you&#8217;re doing this course. But if you don&#8217;t, or if your <em>real</em> project is going to be a large one and you don&#8217;t want to start it while a new user, or you just feel like doing a bit of good in return for free internet stuff, consider this:</p></div>
<div class="paragraph"><p>I thought I&#8217;d invite  everyone who takes this course to contribute a piece to an opensource library. Anyone who takes the course should be well equipped to contribute. It&#8217;s not a requirement, but is a source of many small, semi-independent tasks suitable for cementing learning.</p></div>
<div class="paragraph"><p>I don&#8217;t like big, monolithic libraries. It&#8217;s frustrating to discover you have to accept a big memory hit and a bunch of painful setup to get one cool little bit. So I&#8217;m making a set of small, mostly independent tools to do common web patterns.</p></div>
<div class="paragraph"><p>I&#8217;m calling it <strong>Weblog</strong> a library that makes common web interaction patterns easier.</p></div>
<div class="paragraph"><p>If you&#8217;re up for it, head over to <a href="https://github.com/Anniepoo/weblog"">the Weblog repo on github</a>, grab a copy, then head to <a href="http://www.welie.com/patterns/index.php">Welie.com</a> and find yourself a pattern you like that isn&#8217;t in weblog yet. Or drop me an email and I&#8217;ll suggest some.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_thanks">20. Thanks</h2>
<div class="sectionbody">
<div class="paragraph"><p>The author wishes to thank Jan Wielemaker, L.K. van der Meij, and confab for pointing out errors and improvements.</p></div>
<div class="paragraph"><p>Thanks to Michael Richter for some of the software pipeline setup that produces these tutorials.</p></div>
<div class="paragraph"><p>This tutorial was partly written using the free online markdown editor <a href="http://dillinger.io/">Dillinger</a>, and partly using the asciidoc plugin for Notepad++ . Thanks to both projects.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">21. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph"><p>Thanks for taking this tutorial. If I can improve anything please email me at <a href="mailto:annie@theelginworks.com">annie@theelginworks.com</a> .</p></div>
<div class="paragraph"><p>If you make something beautiful, drop me a link.</p></div>
<div class="paragraph"><p>Thanks,</p></div>
<div class="paragraph"><p>Annie</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Version 1.3.1<br />
Last updated
 2020-05-19 19:30:05 CEST
</div>
</div>
</body>
</html>
